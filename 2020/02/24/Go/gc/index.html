

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content>
  <meta name="author" content="Doujohner">
  <meta name="keywords" content>
  <title>Golang Garbage Collection - 兜的破烂</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-02-24 22:10" pubdate>
      February 24, 2020 pm
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      989 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      14
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Golang Garbage Collection</h1>
            
            <div class="markdown-body" id="post-body">
              <p>看了下runtime的<s>代码</s>（注释），总结一哈</p>
<a id="more"></a>
<h2 id="目的">目的</h2>
<p>对于所有的垃圾回收器的目的（指标）无非就是以下几个：</p>
<ol>
<li>所占用程序的时间，停顿时间</li>
<li>频率</li>
<li>CPU占比</li>
<li>内存占比（堆开销）</li>
<li>内存的分配方式（碎片化程度）</li>
<li>内存释放方式</li>
<li>并发效果</li>
<li>是否智能化（根据某些系统条件进行调节）</li>
<li>是否可以自定义化参数</li>
</ol>
<h2 id="现在有的比较流行的gc">现在有的比较流行的GC</h2>
<ol>
<li>
<p>简单的refcount，比如redis，即 引用多一个，refcount就+1</p>
</li>
<li>
<p>mark &amp; sweep，标记然后用监视内存的程序或者lazy清理（这个一般不会），golang现在用的就是这种</p>
</li>
<li>
<p>比较牛批的分代收集，如JAVA，什么新生代，老年代，eden等；不过这些都是</p>
</li>
</ol>
<h2 id="go的gc">Go的GC</h2>
<h3 id="步骤">步骤</h3>
<h4 id="触发">触发</h4>
<p>触发gc可以由runtime.GC()(不一定,会判定是否执行)</p>
<p>提供了两个参数来控制GC</p>
<h4 id="1-gcpercent">1.GCPercent</h4>
<blockquote>
<blockquote>
<p>The first one is GCPercent. Basically this is a knob that adjusts how much CPU you want to use and how much memory you want to use. The default is 100 which means that half the heap is dedicated to live memory and half the heap is dedicated to allocation. You can modify this in either direction.</p>
</blockquote>
</blockquote>
<p>代码在runtime/mgc.go中:</p>
<div class="hljs"><pre><code class="hljs go"><span class="hljs-comment">// Initialized from $GOGC.  GOGC=off means no GC.</span>
<span class="hljs-keyword">var</span> gcpercent <span class="hljs-keyword">int32</span>
......
<span class="hljs-comment">//go:linkname setGCPercent runtime/debug.setGCPercent</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setGCPercent</span><span class="hljs-params">(in <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(out <span class="hljs-keyword">int32</span>)</span></span> &#123;
	<span class="hljs-comment">// Run on the system stack since we grab the heap lock.</span>
	systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		lock(&amp;mheap_.lock)
		out = gcpercent
		<span class="hljs-keyword">if</span> in &lt; <span class="hljs-number">0</span> &#123;
			in = <span class="hljs-number">-1</span>
		&#125;
		gcpercent = in
		heapminimum = defaultHeapMinimum * <span class="hljs-keyword">uint64</span>(gcpercent) / <span class="hljs-number">100</span>
		<span class="hljs-comment">// Update pacing in response to gcpercent change.</span>
		gcSetTriggerRatio(memstats.triggerRatio)
		unlock(&amp;mheap_.lock)
	&#125;)
	<span class="hljs-comment">// Pacing changed, so the scavenger should be awoken.</span>
	wakeScavenger()

	<span class="hljs-comment">// If we just disabled GC, wait for any concurrent GC mark to</span>
	<span class="hljs-comment">// finish so we always return with no GC running.</span>
	<span class="hljs-keyword">if</span> in &lt; <span class="hljs-number">0</span> &#123;
		gcWaitOnMark(atomic.Load(&amp;work.cycles))
	&#125;

	<span class="hljs-keyword">return</span> out
&#125;</code></pre></div>
<ul>
<li>默认值是100，意味着一半的堆会用于实时内存，另一半的堆会用来分配</li>
<li></li>
</ul>
<h4 id="2-maxheap">2.Maxheap</h4>
<blockquote>
<blockquote>
<p>MaxHeap, which is not yet released but is being used and evaluated internally, lets the programmer set what the maximum heap size should be. Out of memory, OOMs, are tough on Go; temporary spikes in memory usage should be handled by increasing CPU costs, not by aborting. Basically if the GC sees memory pressure it informs the application that it should shed load. Once things are back to normal the GC informs the application that it can go back to its regular load. MaxHeap also provides a lot more flexibility in scheduling. Instead of always being paranoid about how much memory is available the runtime can size the heap up to the MaxHeap.</p>
</blockquote>
</blockquote>
<ul>
<li>还在实验中… 最主要提供一些监控，会提示程序内存不足；还会使调度更加灵活；</li>
</ul>
<h4 id="方法">方法</h4>
<p>golang现在使用的是叫 <strong>三色回收</strong>的东西：
比较旧的版本:
大概步骤：</p>
<ol>
<li>所有对象初始都设为 <strong>白色</strong></li>
<li>从RootSet出发（即堆里面的对象，比如全局变量，所有的栈对象等），标记第一次所有可达到的对象为<strong>灰色</strong> ,这个过程,这里会stop the world;</li>
<li>然后紧接着在第一个发现的各个对象上继续寻找引用这些对象的对象们，找到后（或者在这些基础上已经找不到了）就把第一次所有可达的对象转为<strong>黑色</strong>,这时会start the world;
而这些找到的对象们就标为<strong>灰色</strong> ;</li>
<li>重复第二,三步,直到所有</li>
</ol>
<div class="hljs"><pre><code class="hljs golang">
</code></pre></div>
<h3 id="做过的一些优化">做过的一些优化</h3>
<h4 id="size-segregated-span-分片隔离">size segregated span （分片隔离）</h4>
<ol>
<li>garbage collector要快速地找到object的开始位置，如果能知道在某个span中的object的大小，就可以直接往下舍入查找到位置</li>
<li>更小的碎片化</li>
<li>内部结构化？</li>
<li></li>
</ol>
<h3 id="调查一下其他部分">调查一下其他部分</h3>
<p>有这个一个变量： <strong>gcphase</strong></p>
<div class="hljs"><pre><code class="hljs go"><span class="hljs-comment">// Garbage collector phase.</span>
<span class="hljs-comment">// Indicates to write barrier and synchronization task to perform.</span>
<span class="hljs-keyword">var</span> gcphase <span class="hljs-keyword">uint32</span></code></pre></div>
<p>write barrier写屏障</p>
<div class="hljs"><pre><code class="hljs go"><span class="hljs-comment">// The compiler knows about this variable.</span>
<span class="hljs-comment">// If you change it, you must change builtin/runtime.go, too.</span>
<span class="hljs-comment">// If you change the first four bytes, you must also change the write</span>
<span class="hljs-comment">// barrier insertion code.</span>
<span class="hljs-keyword">var</span> writeBarrier <span class="hljs-keyword">struct</span> &#123;
	enabled <span class="hljs-keyword">bool</span>    <span class="hljs-comment">// compiler emits a check of this before calling write barrier</span>
	pad     [<span class="hljs-number">3</span>]<span class="hljs-keyword">byte</span> <span class="hljs-comment">// compiler uses 32-bit load for "enabled" field</span>
	needed  <span class="hljs-keyword">bool</span>    <span class="hljs-comment">// whether we need a write barrier for current GC phase</span>
	cgo     <span class="hljs-keyword">bool</span>    <span class="hljs-comment">// whether we need a write barrier for a cgo check</span>
	alignme <span class="hljs-keyword">uint64</span>  <span class="hljs-comment">// guarantee alignment so that compiler can use a 32 or 64-bit load</span>
&#125;</code></pre></div>
<h3 id="具体实现">具体实现</h3>
<ol>
<li>bitmap
/runtime/mbitmap.go
使用bitmap</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/golang/">golang</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/03/01/redis/basic/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Redis basis</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/02/24/Go/memManage/">
                        <span class="hidden-mobile">Golang Memory Allocator</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Golang Garbage Collection&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
