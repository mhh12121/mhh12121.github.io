<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>å…œçš„ç ´çƒ‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="å…œçš„ç ´çƒ‚">
<meta property="og:url" content="https://mhh12121.github.io/index.html">
<meta property="og:site_name" content="å…œçš„ç ´çƒ‚">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å…œçš„ç ´çƒ‚">
  
    <link rel="alternate" href="/atom.xml" title="å…œçš„ç ´çƒ‚" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">å…œçš„ç ´çƒ‚</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">å­¦ä¹ â˜†è®°å½•</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="æœç´¢"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://mhh12121.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Comcon/somethingAboutTcp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/02/Comcon/somethingAboutTcp/" class="article-date">
  <time datetime="2019-07-02T07:01:00.000Z" itemprop="datePublished">2019-07-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/02/Comcon/somethingAboutTcp/">Something about Networking</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3>ä¸ºä»€ä¹ˆå¤šä¸ªtcpè¿æ¥ä¼šæ¯”å•ä¸ªtcpè¿æ¥å¿«ï¼Ÿï¼ˆtmdé¢è¯•å‚»äº†ï¼Œå±…ç„¶æ²¡ç­”å‡ºæ¥è¿™ä¸ªï¼‰</h3>
<p>ä¸€å¼€å§‹çœ‹è§ï¼Œè¿™ä¸æ˜¯æ˜¾è€Œæ˜“è§çš„å—ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>åæ¥å‘ç°ï¼Œå…¶å®ä»–æƒ³å¬åˆ°çš„ç­”æ¡ˆæ˜¯ï¼š</p>
<ol>
<li>tcpçš„æµé‡çª—å£ï¼ˆæ‹¥å¡æ§åˆ¶ï¼‰
å¦‚ä¸‹å›¾ï¼š
<img src="/img/tcpWindow.jpg" alt="tcpwindow">ç›—å›¾
ç»¿è‰²ä¸º å‘é€è€…å‘é€ï¼Œä¸”æ¥æ”¶è€…acked
é»„è‰²ä¸º å‘é€è€…å‘é€ï¼Œæ¥æ”¶è€…æœªç¡®è®¤ï¼ˆin-flightï¼‰
è“è‰²ä¸º å¯ç”¨ä½†ä¸ºå‘é€</li>
</ol>
<p>cwnd= widthï¼ˆin-flightï¼‰+widthï¼ˆnot sentï¼‰</p>
<p>å‘é€é€Ÿç‡ï¼š
<strong>rate = cwnd / RTT byte/sec</strong>
å³å‘é€é€Ÿç‡åœ¨RTTï¼ˆå¾€è¿”æ—¶å»¶ï¼‰ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œåªå—cwndå½±å“</p>
<ol start="2">
<li>æ…¢å¯åŠ¨</li>
</ol>
<p>tcpä¼šè¿›è¡Œ<strong>æ…¢å¯åŠ¨</strong>ç›´åˆ°ä¸¢åŒ…,æ¯æ¥åˆ°ä¸€ä¸ªackå°±ä¼šæŠŠçª—å£ï¼ˆcwndï¼‰Ã—2ï¼Œå½“å‡ºç°ä¸¢åŒ…çš„ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§çŠ¶å†µï¼š</p>
<ol>
<li>æ¥æ”¶è€…å‘é€ç»™å‘é€è€…çš„ACKä¸¢å¤±ï¼Œä¼šå¯¼è‡´ timeout</li>
<li>å‘é€è€…å‘é€ç»™æ¥æ”¶è€…çš„æ•°æ®ä¸¢å¤±ï¼Œå‘é€è€…ä¼šæ”¶åˆ°æ¥å—è€…çš„é‡å¤ACKï¼Œå¦‚æœæ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ACKï¼Œå¯ä»¥ç¡®è®¤ä¸ºä¸¢åŒ…</li>
</ol>
<ol start="3">
<li>è·¯ç”±å™¨ï¼ˆå¤šä¸ªTCPæœ‰æ‹¥å¡æ§åˆ¶ï¼‰
ç»™å‡ºå¸¦å®½ä¸ºRï¼Œæœ‰Kä¸ªè¿æ¥ç»è¿‡
æœ€åæ¯ä¸ªè¿æ¥å¹³å‡åˆ†çš„éƒ½ä¼šæ˜¯ R/K</li>
</ol>
<p>ç»ˆä¸Šï¼š</p>
<p>ä¸€ä¸ªtcpè¿æ¥å¾ˆå¯èƒ½ä¸èƒ½æŠŠå½“å‰è·¯ç”±çš„å¸¦å®½éƒ½ç”¨å®Œï¼ˆï¼‰ï¼Œæ‰€ä»¥è¦å¤šä¸ªtcpè¿æ¥ï¼Œè¿™æ ·æ‰èƒ½æœ€å¤§ä¿è¯é€Ÿç‡</p>
<h3>æ€»ç»“</h3>
<p>å›ç­”é—®é¢˜ï¼Œè¦ä»ç‰¹ä¹ˆåŸç†å¼€å§‹ä¸€æ­¥æ­¥æ¨å¯¼æ¥èªªï¼Œä¸èƒ½æƒ³å½“ç„¶</p>
<h3>å„ç§æ¡æ‰‹æŒ¥æ‰‹ï¼ˆæˆ‘æ±‚æ±‚æˆ‘è‡ªå·±æŠŠè¿™äº›gdxè®°å¾—æ»šç“œçƒ‚ç†Ÿï¼Œæ¯æ¬¡éƒ½æ¼ä¸€ç‚¹ï¼‰</h3>
<p>TCPè¿æ¥</p>
<ol start="3">
<li>DNSåè®®</li>
</ol>
<p>é¦–å…ˆè¿™ğŸ”æ˜¯<strong>åº”ç”¨å±‚</strong>åè®®ï¼ï¼ï¼
:smile:</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/07/02/Comcon/somethingAboutTcp/" data-id="cjxmwz4sw000faeugkc4f6v0t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/networking/">networking</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/gRPC" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/29/Go/gRPC/" class="article-date">
  <time datetime="2019-06-29T06:40:00.000Z" itemprop="datePublished">2019-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/29/Go/gRPC/">Something in gRPC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>å¸¸ç”¨çš„rpcæ¡†æ¶ï¼Œæˆ‘ä»¬å…ˆä»å®ƒçš„protoå¼€å§‹äº†è§£å§</p>
<p>æˆ‘ä»¬è¿™é‡Œåªè®¨è®ºgoè¯­æ³•ï¼Œè¯­è¨€æ–¹é¢å…¶ä»–éƒ½æ˜¯å¤§åŒå°å¼‚</p>
<h2>proto</h2>
<p>åˆ›å»ºprotoæ–‡ä»¶ <strong>data.proto</strong>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line"></span><br><span class="line">service Authenticate&#123;</span><br><span class="line">	rpc login(toServerData) returns (ResponseFromServer)&#123;&#125;</span><br><span class="line">	rpc home(toServerData) returns(ResponseFromServer)&#123;&#125;</span><br><span class="line">	rpc logout(toServerData) returns(ResponseFromServer)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message toServerData&#123;</span><br><span class="line">    required <span class="keyword">int32</span> ctype = <span class="number">1</span>;</span><br><span class="line">    optional bytes httpdata=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">message ResponseFromServer &#123;</span><br><span class="line">	required <span class="keyword">bool</span> Success=<span class="number">1</span>;</span><br><span class="line">	optional bytes tcpData=<span class="number">2</span>;</span><br><span class="line">	<span class="comment">// Errcode int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç”¨å®‰è£…çš„protocæ’ä»¶ç”Ÿæˆ
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path=/mypath --go_out=plugins=grpc:. *.proto //å½“å‰åœ¨mypathè·¯å¾„ä¸‹ï¼Œç”¨grpcæ¨¡å¼ç”Ÿæˆprotoæ–‡ä»¶</span><br></pre></td></tr></table></figure></p>
<p>ç”Ÿæˆ <strong>data.pb.proto</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/29/Go/gRPC/" data-id="cjxmwz4t8000qaeug3ij9grd1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ToMyLover" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/26/ToMyLover/" class="article-date">
  <time datetime="2019-06-26T03:40:00.000Z" itemprop="datePublished">2019-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/26/ToMyLover/">To my lover</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I was looking for something until met you,
So I found the whole world</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/26/ToMyLover/" data-id="cjxmwz4s50004aeugou5vl66n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Love/">Love</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/Context" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/21/Go/Context/" class="article-date">
  <time datetime="2019-06-21T03:40:00.000Z" itemprop="datePublished">2019-06-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/21/Go/Context/">Golang Context</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Golangå‡ºè‰²çš„åç¨‹ä¸ºå…¶å¢æ·»ä¸å°‘è‰²å½©ï¼Œè€ŒContextåœ¨åç¨‹é—´çš„åä½œï¼ŒåŒæ­¥å‘æŒ¥äº†å¾ˆå¤§çš„ä½œç”¨
&lt;!--more--&gt;</p>
<p><img src="/img/golangContextMascot.jpg" alt="Context"></p>
<h2>ä½œç”¨</h2>
<p>å¼€å¤´å·²ç»è¯´é“ï¼ŒContextä¸»è¦ç”¨äºåœ¨goroutineä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¿¡æ¯åŒ…æ‹¬key-value pairï¼Œcancelä¿¡å·ï¼Œtimeoutä¿¡å·ç­‰
httpåŒ…ï¼ŒsqlåŒ…é‡Œé¢éƒ½ç”¨åˆ°äº†contextï¼Œæ¯”å¦‚httpåŒ…é‡Œé¢ï¼ŒAPIå¯ä»¥ç”±å¤–éƒ¨æ‰§è¡Œcancelæ“ä½œï¼Œå¯ä»¥è®¾ç½®timeoutä¿¡å·æ¥cancel
httpè¯·æ±‚æœåŠ¡å¦‚æœè¿‡æ…¢ï¼Œåˆ™å¯ä»¥ç”¨timeoutè¿›è¡Œé‡Šæ”¾èµ„æº
ä¸¾ä¾‹ï¼šè·å–å•†å“çš„é»˜è®¤åº“å­˜æ•°é‡ç­‰</p>
<p><strong><em>å‚è€ƒ goåœ¨ä»Šæ—¥å¤´æ¡çš„å®è·µ</em></strong></p>
<p>å¦å¤–ï¼Œä¹‹å‰çš„<img src="/Concurrency" alt="Concurrency"> æœ‰è°ˆåˆ°åç¨‹ä¹‹å‰å¦‚ä½•åŒæ­¥ï¼ˆæ¯”å¦‚ channelå’Œselectï¼‰
ä½†å¦‚æœè¦å…±äº«ä¸€äº›å…¨å±€å˜é‡ï¼Œæˆ–è€…éœ€è¦åŒæ—¶è¢«å…³é—­ï¼Œå°±å¯ä»¥ç”¨contextæ¥å®ç°</p>
<h2>æºç </h2>
<p>å¯ä»¥å‚è€ƒå®˜æ–¹blog<img src="https://blog.golang.org/context" alt="context blog"></p>
<p>æ•´ä½“æä¾›äº†ï¼š
&lt;table&gt;
&lt;tr&gt;
&lt;th&gt;Name&lt;/th&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Usage&lt;/th&gt;
&lt;th&gt;Comment&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Context&lt;/td&gt;
&lt;td&gt;Interface&lt;/td&gt;
&lt;td&gt;Define four methods:&lt;br&gt;&lt;br&gt;Deadline() (deadline time.Time, ok bool)&lt;br&gt;Done()&lt;-chan struct{}&lt;br&gt;Err() error&lt;br&gt;Value(key interface{}) interface{}&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;emptyCtx&lt;/td&gt;
&lt;td&gt;struct&lt;/td&gt;
&lt;td&gt;Also define interface, but it's empty&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CancelFunc&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;cancel func&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CancelCtx&lt;/td&gt;
&lt;td&gt;struct&lt;/td&gt;
&lt;td&gt;mark as cancelable&lt;/td&gt;
&lt;td rowspan=&quot;3&quot;&gt;éƒ½æœ‰å®ç°è‡ªå·±çš„æ–¹æ³•&lt;br&gt;&lt;br&gt;&lt;br&gt;Cancel()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;timerCtx&lt;/td&gt;
&lt;td&gt;struct&lt;/td&gt;
&lt;td&gt;canceled if timeout&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;valueCtx&lt;/td&gt;
&lt;td&gt;struct&lt;/td&gt;
&lt;td&gt;save K-V pair&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Background&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;Background returns a non-nil, empty Context. It is never canceled, has no&lt;br&gt;values, and has no deadline. It is typically used by the main function,&lt;br&gt; initialization, and tests, and as the top-level Context for incoming requests.&lt;/td&gt;
&lt;td&gt;è¿”å›ç©ºçš„contextï¼Œå¸¸ç”¨åštop-level context&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;TODO&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;TODO returns a non-nil, empty Context.&lt;br&gt;Code should use context.TODO when it' s unclear which Context to use or it is not yet available&lt;br&gt; (because the surrounding function has not yet been extended to accept a Context&lt;br&gt;parameter). TODO is recognized by static analysis tools that determine&lt;br&gt;whether Contexts are propagated correctly in a program.&lt;/td&gt;
&lt;td&gt;è¿”å›ç©ºçš„context&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WithCancel&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;Based on parent context, generate a cancelable context&lt;/td&gt;
&lt;td&gt;åŸºäºçˆ¶contextç”Ÿæˆå¯å–æ¶ˆcontext&lt;br&gt;(è‡ªç„¶å°±ä¼šè°ƒç”¨ä¸‹é¢çš„propagateCancel)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;newCancelCtx&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;create a cancelable context&lt;/td&gt;
&lt;td&gt;è¿”å›ä¸€ä¸ªCancelCtx&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;propagateCancel&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;propagateCancel arranges for child to be canceled&lt;/td&gt;
&lt;td&gt;å‘ä¸‹ä¼ é€’contextçš„å…³ç³»&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;parentCancelCtx&lt;/td&gt;
&lt;td&gt;func &lt;/td&gt;
&lt;td&gt;parentCancelCtx follows a chain of parent references until it finds a&lt;br&gt;&lt;br&gt;*cancelCtx. This function understands how each of the concrete types in this&lt;br&gt;&lt;br&gt;package represents its parent.&lt;/td&gt;
&lt;td&gt;æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯å–æ¶ˆçš„çˆ¶èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;removeChild&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;remove child&lt;/td&gt;
&lt;td&gt;å»æ‰çˆ¶èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;init&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;init this package&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WithDeadLine&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;Create a context with deadline&lt;/td&gt;
&lt;td rowspan=&quot;3&quot;&gt;åŒç†ï¼Œéƒ½æ˜¯ä¸ºäº†åˆ›å»ºä¸åŒåŠŸèƒ½çš„context&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WithTimeout&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WIthValue&lt;/td&gt;
&lt;td&gt;func&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;</p>
<p>contexté‡Œé¢çš„ç±»å›¾ï¼š</p>
<p><img src="/img/go_context.png" alt="contextClass"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå±•å¼€</p>
<h3>Interface</h3>
<h4>Context</h4>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">//deadlineä¼šè¿”å› è¿™ä¸ªcontextåº”è¯¥è¢«å–æ¶ˆçš„æ—¶é—´ï¼Œ å¦‚æœok==falseï¼ŒæŒ‡æ²¡æœ‰deadlineè®¾ç½®ï¼ˆå³è¿”å›deadlineçš„æ—¶é—´æˆ–è€…è¿”å›æ²¡æœ‰è®¾ç½®deadlineï¼‰</span></span><br><span class="line">	Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line">    <span class="comment">//è¿”å›ä¸€ä¸ªå…³é—­çš„åªè¯»channel ï¼Œä»£è¡¨ç€è¿™ä¸ªcontextåº”è¯¥è¢«cancelæˆ–è€…åˆ°äº†deadline</span></span><br><span class="line">    </span><br><span class="line">	Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    <span class="comment">//channel Doneï¼ˆï¼‰å…³é—­åï¼Œè¿”å›å…³é—­åŸå› </span></span><br><span class="line">	Err() error</span><br><span class="line">    <span class="comment">//è·å–keyå¯¹åº”çš„valueå€¼</span></span><br><span class="line">	Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…³äº <strong>Done()</strong> éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ˜¯ä¸€ä¸ª<strong>åªè¯»</strong> çš„ <strong>channel</strong>ï¼</p>
<ol>
<li>åªæœ‰åœ¨å…¶è¢«å…³é—­åï¼Œæ‰å¯ä»¥ä»é‡Œé¢è¯»å‡ºå€¼ï¼Œ è€Œä¸”è¿™ä¸ªå€¼æ˜¯ç›¸åº”ç±»å‹çš„ <strong>é›¶å€¼</strong>ï¼Œæ‰€ä»¥goroutineå¯ä»¥åœ¨å…¶å…³é—­åè¯»å‡ºé›¶å€¼ï¼Œåˆ¤æ–­åç»§ç»­åšåé¢çš„äº‹æƒ…</li>
<li>å…¶å…·æœ‰å…³è”æ€§ï¼Œå³æ‰€æœ‰ç”¨åˆ°è¿™ä¸ªcontextçš„goroutineï¼Œä¸€æ—¦æœ‰ä¸€æ–¹å…³é—­äº†(Done())ï¼Œå…¶ä»–çš„ä¹Ÿä¼šè¢«å…³é—­</li>
</ol>
<h4>Canceler</h4>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A canceler is a context type that can be canceled directly. The</span></span><br><span class="line"><span class="comment">// implementations are *cancelCtx and *timerCtx.</span></span><br><span class="line"><span class="keyword">type</span> canceler <span class="keyword">interface</span> &#123;</span><br><span class="line">	cancel(removeFromParent <span class="keyword">bool</span>, err error)</span><br><span class="line">	Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æºç è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™ä¸ªæ¥å£ä¼šè¢« *cancelCtxå’Œ *timerCtx å®ç°</p>
<p>//todo ä¸ºå•¥ Canceleré‡Œé¢æœ‰ cancel()ï¼Œè€ŒContexté‡Œé¢ æ²¡æœ‰å‘¢,æ˜¯ç§è®¾è®¡é—®é¢˜å§ï¼Ÿcontextæœ‰ä¸€äº›ä¸ä¼šç”¨åˆ°cancelï¼Œæ¯”å¦‚emptyCtxï¼Ÿ</p>
<h3>struct</h3>
<h4>emptyCtx</h4>
<p>è¿™ä¸ªæš‚æ—¶ç•¥è¿‡ï¼Œåªè¦çŸ¥é“æŠŠè¿™ä¸ªå½“æˆä¸€ä¸ªå ä½ç¬¦å³å¯ï¼Œæœ‰äº›å‡½æ•°å¯èƒ½ä»¥åä¼šç”¨åˆ°contextï¼Œæš‚æ—¶æŠŠå®ƒå½“ä½œä¸€ä¸ªå‚æ•°ä¼ è¿›å»è€Œå·²
å®ƒçš„ç›¸å…³æ–¹æ³•æœ‰background() å’Œ TODO()
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// An emptyCtx is never canceled, has no values, and has no deadline. It is not</span></span><br><span class="line"><span class="comment">// struct&#123;&#125;, since vars of this type must have distinct addresses.</span></span><br></pre></td></tr></table></figure></p>
<h4>cancelCtx</h4>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A cancelCtx can be canceled. When canceled, it also cancels any children</span></span><br><span class="line"><span class="comment">// that implement canceler.</span></span><br><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">	Context</span><br><span class="line">	mu       sync.Mutex            <span class="comment">// protects following fields</span></span><br><span class="line">	done     <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;         <span class="comment">// created lazily, closed by first cancel call</span></span><br><span class="line">	children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// set to nil by the first cancel call</span></span><br><span class="line">	err      error                 <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªcancelCtx æœ‰å®ç°äº†æ¥å£ <strong>Context</strong>
æˆ‘ä»¬æ³¨æ„åˆ°æºç ä¸­è¯´åˆ° doneæ˜¯ created lazilyï¼Œå³è¿™ä¸ªä¸æ˜¯åˆå§‹åŒ–å°±ä¼šæœ‰;å‘ç°è¿™ä¸ªåœ¨å…¶ä¸‹çš„Done()æ–¹æ³•é‡Œé¢æ‰ä¼šåˆå§‹åŒ–ï¼š</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">Done</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125; &#123;</span><br><span class="line">	c.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> c.done == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)<span class="comment">//è¿™é‡Œ</span></span><br><span class="line">	&#125;</span><br><span class="line">	d := c.done</span><br><span class="line">	c.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span> d</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å‰é¢è¯´åˆ° è¿™ä¸ª <strong>&lt;-chan struct{}</strong> æŒ‡çš„æ˜¯åªè¯» channelï¼Œåœ¨å…¶ä»–åœ°æ–¹å¦‚æœè¯»å–çš„è¯ï¼ˆè¿˜æ²¡å…³é—­ï¼‰ä¼šblockä½</p>
<p>ç´§æ¥ç€**cancel()**æ–¹æ³•</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cancel closes c.done, cancels each of c's children, and, if</span></span><br><span class="line"><span class="comment">// removeFromParent is true, removes c from its parent's children.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span> <span class="title">cancel</span><span class="params">(removeFromParent <span class="keyword">bool</span>, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"context: internal error: missing cancel error"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	c.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> c.err != <span class="literal">nil</span> &#123;<span class="comment">//å‰é¢è¯´é“erræ˜¯å½“timeoutæˆ–è€…cancelçš„æ—¶å€™ä¼šæ·»åŠ ï¼Œæ‰€ä»¥æœ‰errå°±ä¸€å®šæ˜¯è¢«å–æ¶ˆäº†ï¼ˆvar Canceled = errors.New("context canceled")ï¼‰</span></span><br><span class="line">		c.mu.Unlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="comment">// already canceled</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.err = err</span><br><span class="line">	<span class="keyword">if</span> c.done == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.done = closedchan <span class="comment">//var closedchan = make(chan struct&#123;&#125;)</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">close</span>(c.done)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> child := <span class="keyword">range</span> c.children &#123;<span class="comment">//loopæ‰€æœ‰çš„childrenï¼Œæ¯ä¸ªéƒ½è°ƒç”¨cancelï¼ˆï¼‰</span></span><br><span class="line">		<span class="comment">// <span class="doctag">NOTE:</span> acquiring the child's lock while holding parent's lock.//ä¸ºå•¥è¦é”ä½å‘¢ï¼Œgolangé‡Œé¢æ²¡æœ‰å¯é‡å…¥é”ï¼Œæ‰€ä»¥childå’Œparentçš„é”éƒ½æ˜¯åˆ†å¼€çš„</span></span><br><span class="line">		child.cancel(<span class="literal">false</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	c.children = <span class="literal">nil</span><span class="comment">//æŠŠchildrenå­—æ®µè®¾ä¸ºnil</span></span><br><span class="line">	c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> removeFromParent &#123;<span class="comment">//ä»çˆ¶contextç§»é™¤è‡ªå·±</span></span><br><span class="line">		removeChild(c.Context, c)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æºç æ³¨é‡Šå†™ç€</p>
<ol>
<li>cancelä¼šå…³é—­æ‰ doneè¿™ä¸ªchannelï¼Œè¿˜ä¼šcancelæ‰cçš„æ‰€æœ‰children</li>
<li>å¦‚æœremoveFromparent æ˜¯trueï¼Œæœ€åè°ƒç”¨removeChild()</li>
</ol>
<h5>Cancelï¼ˆï¼‰æ–¹æ³•çš„æµç¨‹ï¼š</h5>
<ol>
<li>å…³é—­c.Done() channelï¼Œç„¶åä¸æ–­åœ°cancelå®ƒçš„å­èŠ‚ç‚¹</li>
<li>å¹¶ä»çˆ¶èŠ‚ç‚¹ç§»é™¤è‡ªå·±ï¼ˆremoveFromParentï¼‰</li>
</ol>
<p>è‡ªç„¶åœ°ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹removeChild()å‡½æ•°
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// removeChild removes a context from its parent.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeChild</span><span class="params">(parent Context, child canceler)</span></span> &#123;</span><br><span class="line">	p, ok := parentCancelCtx(parent)<span class="comment">//æ‹¿å‡ºçˆ¶contextï¼Œè¿™é‡Œæ˜¯p</span></span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	p.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> p.children != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">delete</span>(p.children, child)<span class="comment">//ç›´æ¥ä»mapé‡Œé¢åˆ é™¤è¿™ä¸ªchildï¼ˆåˆ é™¤è‡ªå·±ï¼‰</span></span><br><span class="line">	&#125;</span><br><span class="line">	p.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&lt;del&gt;PSï¼šé‡Œé¢çš„parentCancelCtxï¼ˆï¼‰åæ¥å‘ç°é—®é¢˜å‡ºåœ¨ valueCtxä¸Šé¢ï¼Œæˆ‘ä»¬æ”¾åœ¨ <a href>valueCtx</a> è®² &lt;/del&gt;</p>
<h5>WithCancelï¼ˆï¼‰æµç¨‹ï¼š</h5>
<p>æˆ‘ä»¬å›åˆ°ä¸Šé¢çš„<strong>cancel()</strong> æ–¹æ³•ï¼Œè¾“å…¥çš„removeFromParentä»€ä¹ˆæ—¶å€™æ˜¯true or falseå‘¢ï¼Œå…¨å±€æŸ¥æ‰¾åå‘ç°åœ¨**WithCancel()**é‡Œé¢æœ‰ç”¨åˆ°ï¼Œ
åŒæ—¶è¿™ä¹Ÿæ˜¯ä¸€ä¸ªExportå‡ºå»ï¼ˆå¤§å†™ï¼‰çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªå¯cancelçš„Contextï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A CancelFunc tells an operation to abandon its work.</span></span><br><span class="line"><span class="comment">// A CancelFunc does not wait for the work to stop.</span></span><br><span class="line"><span class="comment">// After the first call, subsequent calls to a CancelFunc do nothing.</span></span><br><span class="line"><span class="keyword">type</span> CancelFunc <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">WithCancel</span> <span class="title">returns</span> <span class="title">a</span> <span class="title">copy</span> <span class="title">of</span> <span class="title">parent</span> <span class="title">with</span> <span class="title">a</span> <span class="title">new</span> <span class="title">Done</span> <span class="title">channel</span>. <span class="title">The</span> <span class="title">returned</span></span></span><br><span class="line"><span class="function">// <span class="title">context</span>'<span class="title">s</span> <span class="title">Done</span> <span class="title">channel</span> <span class="title">is</span> <span class="title">closed</span> <span class="title">when</span> <span class="title">the</span> <span class="title">returned</span> <span class="title">cancel</span> <span class="title">function</span> <span class="title">is</span> <span class="title">called</span></span></span><br><span class="line"><span class="function">// <span class="title">or</span> <span class="title">when</span> <span class="title">the</span> <span class="title">parent</span> <span class="title">context</span>'<span class="title">s</span> <span class="title">Done</span> <span class="title">channel</span> <span class="title">is</span> <span class="title">closed</span>, <span class="title">whichever</span> <span class="title">happens</span> <span class="title">first</span>.</span></span><br><span class="line"><span class="function">//</span></span><br><span class="line"><span class="function">// <span class="title">Canceling</span> <span class="title">this</span> <span class="title">context</span> <span class="title">releases</span> <span class="title">resources</span> <span class="title">associated</span> <span class="title">with</span> <span class="title">it</span>, <span class="title">so</span> <span class="title">code</span> <span class="title">should</span></span></span><br><span class="line"><span class="function">// <span class="title">call</span> <span class="title">cancel</span> <span class="title">as</span> <span class="title">soon</span> <span class="title">as</span> <span class="title">the</span> <span class="title">operations</span> <span class="title">running</span> <span class="title">in</span> <span class="title">this</span> <span class="title">Context</span> <span class="title">complete</span>.</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span> <span class="params">(ctx Context, cancel CancelFunc)</span></span> &#123;</span><br><span class="line">	c := newCancelCtx(parent)<span class="comment">//è¿™ä¸ªå°±æ˜¯å¤åˆ¶parent</span></span><br><span class="line">	propagateCancel(parent, &amp;c)</span><br><span class="line">	<span class="keyword">return</span> &amp;c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>ä¼ å…¥parent Contextï¼ˆä¸€èˆ¬æ˜¯backgroundï¼‰ï¼Œè¿”å›ä¸€ä¸ªparentcontextçš„å¤åˆ¶ï¼Œè¿™ä¸ªparent contexæœ‰ <strong>æ–°çš„Done channel</strong></li>
<li>è¿™ä¸ªæ–°ï¼ˆå¤åˆ¶ï¼‰çš„Done channelä¼šåœ¨ä¸¤ç§æƒ…å†µè¢«å…³é—­ï¼ˆä¸ç®¡å“ªä¸ªå…ˆå‘ç”Ÿï¼‰ï¼š
è¿”å›çš„cancel CancelFunc ï¼ˆå¤åˆ¶çš„ï¼‰ è¢«called ï¼ˆæ³¨æ„ï¼Œ<strong>CancelFuncåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ¥ä¸‹æ¥çš„éƒ½ä¼šdo nothing</strong>ï¼‰
parent contextçš„ Done channelè¢«å…³é—­</li>
</ol>
<p><strong>é‚£ä¹ˆåˆ é™¤å‰è¯¥æ€ä¹ˆåŠï¼ˆè°ƒç”¨è¿”å›çš„cancel CancelFuncå‰ï¼‰ï¼Œç›´æ¥æ–­å¼€å½“å‰contextå’Œå…¶parentçš„é“¾æ¥ï¼Ÿ</strong>
ä¸è¡Œï¼Œè¿˜è¦æŠŠå½“å‰contextçš„childrenå…¨éƒ¨cancelæ‰ï¼š
è¿™é‡Œèµ°åˆ°propagateCancel()å‡½æ•°</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// propagateCancel arranges for child to be canceled when parent is.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">propagateCancel</span><span class="params">(parent Context, child canceler)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> parent.Done() == <span class="literal">nil</span> &#123;<span class="comment">//æ²¡æœ‰åˆå§‹åŒ–æ“ä½œï¼Œå³æ²¡æœ‰è°ƒç”¨Done()æ“ä½œï¼Œæ‰€ä»¥è‡ªç„¶ä¸å­˜åœ¨cancel</span></span><br><span class="line">		<span class="keyword">return</span> <span class="comment">// parent is never canceled</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;</span><br><span class="line">		p.mu.Lock()</span><br><span class="line">		<span class="keyword">if</span> p.err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// parent has already been canceled</span></span><br><span class="line">            </span><br><span class="line">			child.cancel(<span class="literal">false</span>, p.err)<span class="comment">//è¿™é‡Œä¼ å…¥çš„å°±æ˜¯falseï¼Œå› ä¸ºçˆ¶contextå·²ç»è¢«cancelæ‰äº†ï¼ˆçˆ¶ä¸å½“å‰childçš„é“¾æ¥æ–­å¼€ï¼‰ï¼Œåªéœ€è¦æŠŠchildå’Œå…¶ä¸‹é¢çš„</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> p.children == <span class="literal">nil</span> &#123;</span><br><span class="line">				p.children = <span class="built_in">make</span>(<span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			p.children[child] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		p.mu.Unlock()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;<span class="comment">//å¦‚æœæ²¡æœ‰æ‰¾åˆ°parent contextï¼ˆå®ƒè‡ªå·±æ˜¯ç©ºçš„ï¼‰ï¼Œå°±æ–°å»ºä¸€ä¸ªgoroutineç›‘è§†parent contextæˆ–è€…child contextçš„doneä¿¡å·</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-parent.Done():<span class="comment">//å¦‚æœæ‰¾ä¸åˆ°çˆ¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªå°±ä¸ä¼šè°ƒç”¨</span></span><br><span class="line">				child.cancel(<span class="literal">false</span>, parent.Err())</span><br><span class="line">			<span class="keyword">case</span> &lt;-child.Done():<span class="comment">//å¯èƒ½çˆ¶èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œè¿™ä¸ªä¼šé‡å¤è®©å­èŠ‚ç‚¹å†å–æ¶ˆä¸€æ¬¡</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»æºç çŸ¥é“ï¼ŒpropagateCancel()ä¸»è¦ç›®çš„æ˜¯å½“parentè¢«cancelï¼ŒæŠŠchildç»™å–æ¶ˆ;ï¼ˆè·Ÿ<strong>cancelï¼ˆï¼‰æ–¹æ³•é‡å ï¼Ÿï¼Ÿï¼Ÿ</strong>ï¼‰
ä¼šä¸æ–­çš„ä¼ æ’­ä¼ æ’­ä¸‹å»ï¼ŒæŠŠparentçš„childrenå­—æ®µå…¨éƒ¨è®¾ä¸ºç©ºçš„struct</p>
<h4>parentCancelCtxç‰¹æ®Šæ€§</h4>
<p>ä¹‹å‰è¯´åˆ°çš„åœ¨è¿™ä¸ªparentCancelCtx() forå¾ªç¯é‡Œé¢ï¼Œä¸‡ä¸€æŠŠå½“å‰contextåµŒå¥—åœ¨ä¸€ä¸ªstructé‡Œé¢ï¼Œ
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentCancelCtx follows a chain of parent references until it finds a</span></span><br><span class="line"><span class="comment">// *cancelCtx. This function understands how each of the concrete types in this</span></span><br><span class="line"><span class="comment">// package represents its parent.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parentCancelCtx</span><span class="params">(parent Context)</span> <span class="params">(*cancelCtx, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;<span class="comment">//å¾ˆå¥‡æ€ªï¼Ÿï¼Ÿï¼Ÿä¸ºå•¥è¦forå‘¢ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">		<span class="keyword">switch</span> c := parent.(<span class="keyword">type</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> *cancelCtx:</span><br><span class="line">			<span class="keyword">return</span> c, <span class="literal">true</span></span><br><span class="line">		<span class="keyword">case</span> *timerCtx:</span><br><span class="line">			<span class="keyword">return</span> &amp;c.cancelCtx, <span class="literal">true</span></span><br><span class="line">		<span class="keyword">case</span> *valueCtx:</span><br><span class="line">			parent = c.Context<span class="comment">//forçš„é—®é¢˜åœ¨è¿™é‡Œ</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4>valueCtx</h4>
<p>ç»“æ„ä½“ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A valueCtx carries a key-value pair. It implements Value for that key and</span></span><br><span class="line"><span class="comment">// delegates all other calls to the embedded Context.</span></span><br><span class="line"><span class="keyword">type</span> valueCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">	Context</span><br><span class="line">	key, val <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é¦–å…ˆå¯ä»¥ç¡®è®¤å®ƒæ˜¯ä¸€ä¸ª<strong>Context</strong> ï¼Œå®ƒçš„ç‹¬ç«‹æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼Œå…¶ä»–éƒ½æ˜¯ç»§æ‰¿contextï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v.WithValue(%#v, %#v)"</span>, c.Context, c.key, c.val)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">if</span> c.key == key &#123;</span><br><span class="line">		<span class="keyword">return</span> c.val</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c.Context.Value(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Valueï¼ˆï¼‰çš„æ–¹æ³•æ˜¯å–å‡ºå¯¹åº”keyçš„valueï¼Œä½†è¿”å›å€¼æ˜¯ <strong>c.Context.Value(key)</strong>ï¼Œæ˜æ˜¾æ˜¯é€’å½’è°ƒç”¨ï¼Œ
å…¶ä¼šä¸€ç›´å¾€å®ƒçš„parent contextæŸ¥æ‰¾ï¼Œkeyæ˜¯å¦ç­‰äºè¾“å…¥çš„keyï¼Œä¸€ç›´åˆ°ç»ˆç‚¹ï¼ˆbackgroundï¼‰
å‰é¢ä¹Ÿè¯´åˆ° <strong>background=newï¼ˆemptyCtxï¼‰</strong>ï¼Œæ‰€ä»¥åœ¨ç»ˆç‚¹è°ƒç”¨çš„å…¶å®æ˜¯**emptyCtx.Value()**è¿”å›çš„æ˜¯nilå€¼</p>
<p>Exportå‡ºå»çš„åˆ›å»ºä¸€ä¸ªvalueCtxçš„æ–¹æ³•ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithValue returns a copy of parent in which the value associated with key is</span></span><br><span class="line"><span class="comment">// val.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Use context Values only for request-scoped data that transits processes and</span></span><br><span class="line"><span class="comment">// APIs, not for passing optional parameters to functions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The provided key must be comparable and should not be of type</span></span><br><span class="line"><span class="comment">// string or any other built-in type to avoid collisions between</span></span><br><span class="line"><span class="comment">// packages using context. Users of WithValue should define their own</span></span><br><span class="line"><span class="comment">// types for keys. To avoid allocating when assigning to an</span></span><br><span class="line"><span class="comment">// interface&#123;&#125;, context keys often have concrete type</span></span><br><span class="line"><span class="comment">// struct&#123;&#125;. Alternatively, exported context key variables' static</span></span><br><span class="line"><span class="comment">// type should be a pointer or interface.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> key == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"nil key"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !reflect.TypeOf(key).Comparable() &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"key is not comparable"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>WithValueï¼ˆï¼‰é€‚ç”¨èŒƒå›´ï¼š<strong>åªç”¨ä¸åœ¨requestä½œç”¨åŸŸå†…çš„æ•°æ®ï¼Œè¿™ç§æ•°æ®æ˜¯åœ¨è¿›ç¨‹æˆ–APIä¼ è¾“æ‰€ç”¨ï¼Œè€Œä¸æ˜¯ä½œä¸ºå‡½æ•°çš„parameterä½¿ç”¨</strong></p>
<p>WithValueï¼ˆï¼‰è§„å®šäº†ï¼š</p>
<ol>
<li>
<p>å…¶keyä¸åº”è¯¥æ˜¯stringæˆ–è€…å…¶ä»–å†…ç½®çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä½¿ç”¨contextåŒ…çš„å…¶ä»–åŒ…ä¹‹é—´äº§ç”Ÿå†²çª</p>
</li>
<li>
<p>æ‰€ä»¥keyåº”è¯¥æ˜¯ç”¨æˆ·è‡ªå·±è®¾ç½®çš„ï¼Œè¦è‡ªå·±è¦†ç›–Comparableï¼ˆï¼‰æ–¹æ³•æ‰è¡Œ
è¿™é‡Œç»™å‡º **Comparable()**çš„æºç è§£é‡Š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Methods applicable only to some types, depending on Kind.</span></span><br><span class="line">	<span class="comment">// The methods allowed for each kind are:</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//	Int*, Uint*, Float*, Complex*: Bits</span></span><br><span class="line">	<span class="comment">//	Array: Elem, Len</span></span><br><span class="line">	<span class="comment">//	Chan: ChanDir, Elem</span></span><br><span class="line">	<span class="comment">//	Func: In, NumIn, Out, NumOut, IsVariadic.</span></span><br><span class="line">	<span class="comment">//	Map: Key, Elem</span></span><br><span class="line">	<span class="comment">//	Ptr: Elem</span></span><br><span class="line">	<span class="comment">//	Slice: Elem</span></span><br><span class="line">    <span class="comment">//	Struct: Field, FieldByIndex, FieldByName, FieldByNameFunc, NumField</span></span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>ä¸ºäº†é˜²æ­¢èµ‹å€¼ç»™interface{}ï¼Œcontextçš„keyç»å¸¸æ˜¯æœ‰å…·ä½“ç±»å‹çš„structï¼Œæ­¤å¤–ï¼Œexportå‡ºå»çš„keyçš„é™æ€ç±»å‹åº”è¯¥æ˜¯æŒ‡é’ˆæˆ–è€…interface</p>
</li>
</ol>
<h5>æµç¨‹</h5>
<ol>
<li>åˆ¤æ–­keyæ˜¯å¦ä¸ºç©ºï¼Œkeyçš„ç±»å‹æ˜¯å¦åˆæ³•</li>
<li>è¿”å›ä¸€ä¸ªæœ‰parentæŒ‡é’ˆçš„valueCtx;æ‰€ä»¥ï¼Œåˆ›å»ºvalueCtxæ˜¯å¯ä»¥ä»parentå¼€å§‹ä¸€çº§ä¸€çº§å¾€ä¸‹åˆ›å»ºï¼Œå¦‚ä¸‹å›¾ï¼š
<img src="/img/valueCtx.png" alt="valueCtx"></li>
</ol>
<h4>timerCtx</h4>
<p>ç»“æ„ä½“ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A timerCtx carries a timer and a deadline. It embeds a cancelCtx to</span></span><br><span class="line"><span class="comment">// implement Done and Err. It implements cancel by stopping its timer then</span></span><br><span class="line"><span class="comment">// delegating to cancelCtx.cancel.</span></span><br><span class="line"><span class="keyword">type</span> timerCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">	cancelCtx</span><br><span class="line">	timer *time.Timer <span class="comment">// Under cancelCtx.mu.</span></span><br><span class="line"></span><br><span class="line">	deadline time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å®ƒçš„cancelæ–¹æ³•
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span> <span class="title">cancel</span><span class="params">(removeFromParent <span class="keyword">bool</span>, err error)</span></span> &#123;</span><br><span class="line">	c.cancelCtx.cancel(<span class="literal">false</span>, err)</span><br><span class="line">	<span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">		<span class="comment">// Remove this timerCtx from its parent cancelCtx's children.</span></span><br><span class="line">		removeChild(c.cancelCtx.Context, c)</span><br><span class="line">	&#125;</span><br><span class="line">	c.mu.Lock()</span><br><span class="line">	<span class="keyword">if</span> c.timer != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.timer.Stop()</span><br><span class="line">		c.timer = <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	c.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æµç¨‹ï¼š</p>
<ol>
<li>å…ˆè°ƒç”¨é‡Œé¢çš„cancelCtxçš„cancelï¼ˆï¼‰æ–¹æ³•ï¼Œå–æ¶ˆå…¶å­èŠ‚ç‚¹</li>
<li>å¦‚æœè¦</li>
</ol>
<p>å“ªé‡Œç”¨åˆ°timerCtx.cancelï¼ˆï¼‰å‘¢ï¼Œæˆ‘ä»¬çœ‹çœ‹åˆ›å»ºä¸€ä¸ªtimerCtxçš„å‡½æ•°ï¼š</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithTimeout returns WithDeadline(parent, time.Now().Add(timeout)).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Canceling this context releases resources associated with it, so code should</span></span><br><span class="line"><span class="comment">// call cancel as soon as the operations running in this Context complete:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 	func slowOperationWithTimeout(ctx context.Context) (Result, error) &#123;</span></span><br><span class="line"><span class="comment">// 		ctx, cancel := context.WithTimeout(ctx, 100*time.Millisecond)</span></span><br><span class="line"><span class="comment">// 		defer cancel()  // releases resources if slowOperation completes before timeout elapses</span></span><br><span class="line"><span class="comment">// 		return slowOperation(ctx)</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span> <span class="params">(Context, CancelFunc)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithDeadline returns a copy of the parent context with the deadline adjusted</span></span><br><span class="line"><span class="comment">// to be no later than d. If the parent's deadline is already earlier than d,</span></span><br><span class="line"><span class="comment">// WithDeadline(parent, d) is semantically equivalent to parent. The returned</span></span><br><span class="line"><span class="comment">// context's Done channel is closed when the deadline expires, when the returned</span></span><br><span class="line"><span class="comment">// cancel function is called, or when the parent context's Done channel is</span></span><br><span class="line"><span class="comment">// closed, whichever happens first.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Canceling this context releases resources associated with it, so code should</span></span><br><span class="line"><span class="comment">// call cancel as soon as the operations running in this Context complete.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, d time.Time)</span> <span class="params">(Context, CancelFunc)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123;</span><br><span class="line">		<span class="comment">// The current deadline is already sooner than the new one.</span></span><br><span class="line">		<span class="keyword">return</span> WithCancel(parent)</span><br><span class="line">	&#125;</span><br><span class="line">	c := &amp;timerCtx&#123;</span><br><span class="line">		cancelCtx: newCancelCtx(parent),</span><br><span class="line">		deadline:  d,</span><br><span class="line">	&#125;</span><br><span class="line">	propagateCancel(parent, c)</span><br><span class="line">	dur := time.Until(d)</span><br><span class="line">	<span class="keyword">if</span> dur &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		c.cancel(<span class="literal">true</span>, DeadlineExceeded) <span class="comment">// deadline has already passed</span></span><br><span class="line">		<span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	c.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">	<span class="keyword">if</span> c.err == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.timer = time.AfterFunc(dur, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			c.cancel(<span class="literal">true</span>, DeadlineExceeded)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å‘ç°WithTimeoutå’ŒWithDeadlineï¼ˆï¼‰éƒ½å¯ä»¥åˆ›å»ºtimerCtx
åŒºåˆ«ï¼š withTimeoutç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ å…¥durationï¼Œå³è·ç¦»ç°åœ¨çš„æ—¶é—´ï¼ŒwithDeadlineç¬¬äºŒä¸ªå‚æ•°æŒ‡çš„æ˜¯ç»å¯¹æ—¶é—´ï¼Œå³å‡ æ—¶å‡ åˆ†</p>
<p>withDeadlineï¼ˆï¼‰æµç¨‹ï¼š</p>
<ol>
<li>
<p>æ£€æŸ¥å½“å‰çš„deadlineï¼Œå¦‚æœå­˜åœ¨ä¸”å½“å‰deadlineæ¯”ä¼ å…¥çš„æ—¶é—´è¦æ—©ï¼Œé‚£ä¹ˆå°±é€€åŒ–æˆWithCancelï¼ˆï¼‰</p>
</li>
<li>
<p>å¦‚æœä¸å­˜åœ¨deadlineæˆ–è€…ä¼ å…¥æ—¶é—´è¾ƒæ™šï¼ŒæŠŠå½“å‰timerCtxåŠ å…¥åˆ°parent Contexté‡Œé¢;
ä½†æ˜¯æ³¨æ„ï¼Œè¿˜è¦è®¡ç®—ç°åœ¨çš„æ—¶é—´æ˜¯å¦å¤§äºäº†ä¼ å…¥çš„æ—¶é—´ï¼Œå¦‚æœå¤§äºè¯´æ˜å·²ç»è¿‡äº†ä¼ å…¥çš„deadlineï¼Œç›´æ¥é€€åŒ–æˆcancelï¼ˆï¼‰ï¼Œå¹¶ä¼ å…¥exceedé”™è¯¯ä¿¡æ¯ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DeadlineExceeded error = deadlineExceededError&#123;&#125;</span><br><span class="line"><span class="keyword">type</span> deadlineExceededError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(deadlineExceededError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>   &#123; <span class="keyword">return</span> <span class="string">"context deadline exceeded"</span> &#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>å¦‚æœä¸Šè¿°éƒ½ä¸æˆç«‹ï¼Œè°ƒç”¨time.AfterFunc()ï¼Œè§„å®šæ—¶é—´åè°ƒç”¨cancel()</p>
</li>
</ol>
<h3>ä½¿ç”¨ä¾‹å­</h3>
<p>è¿™ä¸ªç»å…¸çš„goroutineæ³„æ¼ï¼š</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">repeatGen</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    c:=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> i:=<span class="number">0</span>;;i++&#123;</span><br><span class="line">            c&lt;-i</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> v:=<span class="keyword">range</span> repeatGen()&#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">        <span class="keyword">if</span> v==<span class="number">3</span>&#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å½“v==3çš„æ—¶å€™ï¼Œbreakå‡ºæ¥ï¼Œä½†è¿™æ—¶å€™repeatGené‡Œé¢çš„goroutineä»ç„¶åœ¨è·‘ï¼Œä¸ä¼šè¢«ç»ˆæ­¢,goroutineå‘ç”Ÿæ³„æ¼</p>
<p>ç”¨contextæ”¹è¿›ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">repeatGen</span><span class="params">(ctx context.Context)</span> &lt;-<span class="title">chan</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    c:=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> i:<span class="number">0</span>;;i++&#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">                <span class="keyword">case</span> &lt;-ctx.Done():<span class="comment">//ç­‰å¾…doneä¿¡å·</span></span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">case</span> c&lt;-i:</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ctx,cancelFunc:=WithCancel(context.Background())</span><br><span class="line">    <span class="keyword">defer</span> cancelFunc()<span class="comment">//æœ€åæ— è®ºæ€ä¹ˆæ ·ä¹Ÿè¦è°ƒç”¨ç¡®ä¿ä¸€å®šèƒ½å…³æ‰ï¼ˆä¸ºä¿ä¸‡ä¸€è€Œå·²ï¼Œä¸ä¸€å®šè¦ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> v:=<span class="keyword">range</span> repeatGen(ctx)&#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">        <span class="keyword">if</span> v==<span class="number">3</span>&#123;</span><br><span class="line">            cancelFunc()<span class="comment">//å®Œæˆç›´æ¥è°ƒç”¨cancel</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong><em>å‚è€ƒã€Šgoè¯­è¨€åœ£ç»ã€‹</em></strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/21/Go/Context/" data-id="cjxmwz4t3000kaeugc9sfwfpe" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/SortedMap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/19/Go/SortedMap/" class="article-date">
  <time datetime="2019-06-19T02:36:00.000Z" itemprop="datePublished">2019-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/19/Go/SortedMap/">Something should be noted in golang&#39;s map</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>There is <strong>SortedMap</strong> or <strong>LinkedHashMap</strong> in Java
Both can ensure the inserted order of elements, but f ** k myself, I found that Go <strong>only supports basic HashMap</strong>
which means you have to do SortedMap and LinkedHashMap by yourself.</p>
<pre><code>                                ----From a damn interview test
</code></pre>
<p>&lt;!--more--&gt;
I met a problem in an interview test:</p>
<p>Given a file containing URLs on every line,you must record all of their occurence times, then save it into a new file
format like:</p>
<pre><code>url1  2times
url2  3times
url3  4times
</code></pre>
<p>But it should be noticed that all urls in new file have the same sequence as those in source files;</p>
<p>å…¶å®ä½ è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>urlé¢‘æ¬¡ç»Ÿè®¡ï¼ˆé¦–å…ˆæƒ³èµ·mapï¼‰</li>
<li>è¦æŒ‰é¡ºåºæ”¾å…¥æ–°æ–‡ä»¶ï¼Ÿï¼Ÿï¼Ÿ//todo</li>
<li>æ–‡ä»¶å¤ªå¤§æ€ä¹ˆåŠï¼ˆæ‹†ä¹˜å¤šä¸ªæ–‡ä»¶ï¼Œè¿›è¡Œæ˜ å°„ï¼Œå†ç»Ÿè®¡ï¼Œä½†è¿™é‡Œåˆä¸çŸ¥é“æ€ä¹ˆä¿è¯é¡ºåºï¼Ÿï¼Ÿï¼ï¼éš¾å€’åªæœ‰æ‰‹åŠ¨å®ç°LinkedHashMapçº¢é»‘æ ‘ï¼Ÿï¼‰</li>
</ol>
<p>Go blog <img src="https://blog.golang.org/go-maps-in-action" alt="map in action"> says:</p>
<blockquote>
<blockquote>
<blockquote>
<p>When iterating over a map with a range loop, the iteration order is not specified and is not guaranteed to be the same from one iteration to the next. Since the release of Go 1.0, the runtime has randomized map iteration order.</p>
</blockquote>
</blockquote>
</blockquote>
<h3>SortedMap</h3>
<p>Someone has already implemented it
From Go blog  <img src="https://blog.golang.org/go-maps-in-action" alt="map in action"></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"sort"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> keys []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> k := <span class="keyword">range</span> m &#123;<span class="comment">//extract all the damn key out</span></span><br><span class="line">    keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">&#125;</span><br><span class="line">sort.Ints(keys)<span class="comment">//sort them</span></span><br><span class="line"><span class="keyword">for</span> _, k := <span class="keyword">range</span> keys &#123;<span class="comment">//then you can get a sorted map</span></span><br><span class="line">    fmt.Println(<span class="string">"Key:"</span>, k, <span class="string">"Value:"</span>, m[k])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>If your <strong>key</strong> is not an int or string or you wanna sort it by yourself:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//we assume a struct is like below:</span></span><br><span class="line"><span class="keyword">type</span> Obj <span class="keyword">struct</span> &#123;</span><br><span class="line">	Title    <span class="keyword">string</span></span><br><span class="line">	Sequence <span class="keyword">int</span></span><br><span class="line">	Size     <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> By <span class="function"><span class="keyword">func</span><span class="params">(o1, o2 *Obj)</span> <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">//<span class="title">ObjSorter</span> <span class="title">joins</span> <span class="title">a</span> <span class="title">By</span> <span class="title">function</span> <span class="title">and</span> <span class="title">a</span> <span class="title">slice</span> <span class="title">of</span> <span class="title">Objs</span> <span class="title">to</span> <span class="title">be</span> <span class="title">sorted</span>.</span></span><br><span class="line"><span class="function"><span class="title">type</span> <span class="title">ObjSorter</span> <span class="title">struct</span></span> &#123;<span class="comment">//to wrap the obj and by function into this struct</span></span><br><span class="line">	objs []Obj</span><br><span class="line">	by   <span class="function"><span class="keyword">func</span><span class="params">(o1, o2 *Obj)</span> <span class="title">bool</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="params">(by By)</span> <span class="title">Sort</span><span class="params">(objs []Obj)</span></span> &#123;</span><br><span class="line">	os := &amp;ObjSorter&#123;</span><br><span class="line">		objs: objs,</span><br><span class="line">		by:   by,</span><br><span class="line">	&#125;</span><br><span class="line">	sort.Sort(os)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ObjSorter)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> s.by(&amp;s.objs[i], &amp;s.objs[j])</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ObjSorter)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	s.objs[i], s.objs[j] = s.objs[j], s.objs[i]</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ObjSorter)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s.objs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Then to use it:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortedMap</span><span class="params">(m <span class="keyword">map</span>[Obj]<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	sortByTitle := <span class="function"><span class="keyword">func</span><span class="params">(o1, o2 *Obj)</span> <span class="title">bool</span></span> &#123; <span class="comment">//sort by Ttitle field</span></span><br><span class="line">		<span class="keyword">return</span> o1.Title &lt; o2.Title</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// sortBySequence := func(o1, o2 *Obj) bool &#123; //sortBy Sequence field</span></span><br><span class="line">	<span class="comment">// 	return o1.Sequence &lt; o2.Sequence</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	tempObjs := <span class="built_in">make</span>([]Obj, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> k := <span class="keyword">range</span> m &#123;</span><br><span class="line">		tempObjs = <span class="built_in">append</span>(tempObjs, k)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	By(sortByTitle).Sort(tempObjs)<span class="comment">//Sorted this</span></span><br><span class="line">	<span class="keyword">for</span> _, k := <span class="keyword">range</span> tempObjs &#123;<span class="comment">//operate this </span></span><br><span class="line">		fmt.Printf(<span class="string">"key:%v,value:%v \n"</span>, k, m[k])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>To test:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    obj1 := &amp;Obj&#123;Title: <span class="string">"4"</span>&#125;</span><br><span class="line">	obj2 := &amp;Obj&#123;Title: <span class="string">"2"</span>&#125;</span><br><span class="line">	obj3 := &amp;Obj&#123;Title: <span class="string">"1"</span>&#125;</span><br><span class="line">	objs := <span class="built_in">make</span>([]*Obj, <span class="number">0</span>)</span><br><span class="line">	objs = <span class="built_in">append</span>(objs, obj1, obj2, obj3)</span><br><span class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[Obj]<span class="keyword">int</span>)</span><br><span class="line">	m[*obj1] = <span class="number">1</span></span><br><span class="line">	m[*obj3] = <span class="number">1</span></span><br><span class="line">	m[*obj2] = <span class="number">1</span></span><br><span class="line">	SortedMap(m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key:&#123;1 0 0&#125;,value:1 </span><br><span class="line">key:&#123;2 0 0&#125;,value:1 </span><br><span class="line">key:&#123;4 0 0&#125;,value:1</span><br></pre></td></tr></table></figure></p>
<p>Above example can be found in <img src="https://golang.org/pkg/sort/" alt="Golang slice doc examples"></p>
<h3>LinkedHashMap</h3>
<p>To just ensure <strong>inserted order</strong>:
you can refer to <img src alt="Java LinkedHashMap">//or arrayMap()</p>
<p><strong>But</strong>
here we won't achieve the LinkedHashMap, it's kind of troublesome...</p>
<p>We do a trade-off between time and space:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//just create a slice to save sequence</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CalcUrls</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sequence:=<span class="built_in">make</span>([]<span class="keyword">string</span>,<span class="number">0</span>)</span><br><span class="line">    m:=<span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    </span><br><span class="line">    url:=fp.ReadLine()</span><br><span class="line">    <span class="keyword">if</span> _,exists:=m[url];exists&#123;</span><br><span class="line">        m[url]++</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        sequence=<span class="built_in">append</span>(sequence,url)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">for</span> _,v:=<span class="keyword">range</span> sequence&#123;</span><br><span class="line">        res:=fmt.Sprintf(<span class="string">"url:%v,times:%v"</span>,v,m[v])</span><br><span class="line">        Writer.write(res)<span class="comment">//write into the new file</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>---------------------------------æ–°å¢---------------------------------------------</strong>
ä¸»è¦æ˜¯çº¢é»‘æ ‘æ˜¯ä¸ºäº†èƒ½ä¾¿äºåˆ é™¤å’Œæ·»åŠ ï¼Œè€Œæˆ‘é‡åˆ°çš„é¢è¯•é¢˜åªè€ƒè™‘æ·»åŠ ï¼Œæ‰€ä»¥æ²¡å¿…è¦ï¼Œ
ä½†æ˜¯éš”äº†ä¸€å¤©ï¼Œè¿˜æ˜¯è§‰å¾—ä¸çˆ½</p>
<p>è‡ªå·±å°è¯•å®ç°ä¸€ä¸‹åŸºäºçº¢é»‘æ ‘çš„mapçœ‹çœ‹ï¼Œå°±å½“åšå¤ä¹ å§ï¼š</p>
<p>é¦–å…ˆï¼Œçº¢é»‘æ ‘ä¹Ÿæ˜¯AVLæ ‘ï¼ŒåŒºåˆ«å°±åªæ˜¯é¢œè‰²ä¸Šçš„åˆ¤æ–­ä¸åŒè€Œå·²ï¼Œæ‰€ä»¥AVLçš„rotateæˆ‘è¿™é‡Œç•¥è¿‡ï¼Œä¸»è¦å°±æ˜¯é¢œè‰²çš„åˆ¤æ–­
è¦ç¬¦åˆ</p>
<ol>
<li>æ¯ä¸ªèŠ‚ç‚¹æ˜¯é»‘æˆ–è€…çº¢</li>
<li>æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²</li>
<li>æ¯ä¸ªå¶å­èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼ˆä¸”ä¸ºnilï¼Œæ·»åŠ çš„æ—¶å€™æ²¡ç”¨åˆ°ï¼Œåˆ é™¤çš„æ—¶å€™ä¼šç”¨ï¼‰</li>
<li>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œå®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²çš„</li>
<li><strong>ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹çš„è·¯å¾„ä¸ŠåŒ…å«ç›¸åŒæ•°ç›®çš„é»‘èŠ‚ç‚¹</strong> ï¼ˆè¿™ä¸ªä¸€è¡Œä»£ç å¯ä»¥æå®šï¼Œä½†ä¹‹åå¾ˆå¯èƒ½ä¼šè¿åç¬¬4ï¼Œæ‰€ä»¥è¦ç´§æ¥ç€è¿›è¡Œå¤„ç†ï¼‰</li>
</ol>
<p>æ’å…¥æ—¶å€™ï¼Œæ£€æŸ¥ï¼š
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»è¦æ€è·¯ï¼Œå…ˆåƒAVLä¸€æ ·æ’å…¥ï¼Œä¹‹åå†è°ƒæ•´</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(brtree *BRTree)</span> <span class="title">insertNode</span><span class="params">(pnode *BRNode)</span></span> &#123;</span><br><span class="line">	tempRoot := brtree.root</span><br><span class="line">	<span class="keyword">var</span> temp *BRNode</span><br><span class="line">	<span class="keyword">for</span> tempRoot != <span class="literal">nil</span> &#123; <span class="comment">//å·²æœ‰æ ¹èŠ‚ç‚¹ï¼Œå°±å¾€ä¸‹loopæ‰¾åˆ°æ’å…¥ç‚¹</span></span><br><span class="line">		temp = tempRoot <span class="comment">//æ¯æ¬¡æ›´æ–°</span></span><br><span class="line">		<span class="keyword">if</span> pnode.val &gt; tempRoot.val &#123;</span><br><span class="line">			tempRoot = tempRoot.right</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tempRoot = tempRoot.left</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	pnode.parent = temp <span class="comment">//æ‰¾åˆ°æœ€åï¼ŒæŠŠpnodeçš„parentæŒ‡å‘æ‰¾åˆ°çš„æœ€åä¸€ä¸ªç‚¹</span></span><br><span class="line">	<span class="keyword">if</span> temp != <span class="literal">nil</span> &#123;    <span class="comment">//ä¸æ˜¯æ ¹èŠ‚ç‚¹</span></span><br><span class="line">		<span class="keyword">if</span> temp.val &lt; pnode.val &#123; <span class="comment">//åˆ¤æ–­æ”¾åœ¨å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘</span></span><br><span class="line">			temp.right = pnode</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			temp.left = pnode</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">//æ ¹èŠ‚ç‚¹</span></span><br><span class="line">		brtree.root = pnode</span><br><span class="line">	&#125;</span><br><span class="line">	pnode.color = RED <span class="comment">//ç›´æ¥æŠŠè¿™ä¸ªé¢œè‰²å…ˆè®¾ç½®ä¸ºçº¢è‰²ï¼ï¼ï¼ä¸»è¦ä¸ºäº†æ»¡è¶³ï¼š</span></span><br><span class="line">	<span class="comment">// ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹çš„è·¯å¾„ä¸ŠåŒ…å«ç›¸åŒæ•°ç›®çš„é»‘èŠ‚ç‚¹ï¼ˆå¯ä»¥è¯•æƒ³ä¸€ä¸‹ï¼Œæœ€ä¸‹æ–¹æ’å…¥ä¸€ä¸ªçº¢è‰²èŠ‚ç‚¹ï¼Œå› ä¸ºç›®å‰çº¢è‰²èŠ‚ç‚¹çš„å¶å­èŠ‚ç‚¹è‚¯å®šæ˜¯é»‘è‰²çš„nilï¼Œæ‰€ä»¥å¿…ä¼šæ»¡è¶³è¿™ä¸ªç‰¹æ€§ï¼‰</span></span><br><span class="line">	brtree.insertCheck(pnode) <span class="comment">//å†æ£€æŸ¥ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½è·Ÿä¸Šé¢çš„ç¬¬4ç‚¹è¿èƒŒäº†ï¼Œæ¯”å¦‚åœ¨çº¢è‰²çš„èŠ‚ç‚¹ä¸‹é¢æ’ä¸€ä¸ªçº¢è‰²çš„èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ’å…¥æ—¶è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(brtree *BRTree)</span> <span class="title">insertCheck</span><span class="params">(pnode *BRNode)</span></span> &#123;</span><br><span class="line">	<span class="comment">//1. è¯¥èŠ‚ç‚¹æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œå³ä¸ºrootï¼ˆä¸ä¸Šé¢insertNodeæ’å…¥ç‚¹çš„æ£€æŸ¥å¹¶ä¸é‡å¤ï¼Œå› ä¸ºæ¥ä¸‹æ¥ä¼šè¿›è¡Œé€’å½’ï¼Œè¿™ä¸ªå±äºè¾¹ç•Œæ¡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªæ£€æŸ¥rootå¿…ä¸å¯å°‘ï¼‰</span></span><br><span class="line">	<span class="keyword">if</span> pnode.parent == <span class="literal">nil</span> &#123;</span><br><span class="line">		brtree.root = pnode</span><br><span class="line">		brtree.root.color = BLACK</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//2.çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²ç›´æ¥æ·»åŠ (ä¸ç”¨ç®¡)ï¼Œçº¢è‰²æ¥ç€å¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> pnode.parent.color == RED &#123;</span><br><span class="line">		<span class="comment">//2.1 çˆ¶ï¼Œå”å”èŠ‚ç‚¹ä¸ä¸ºç©ºè€Œä¸”å…¶é¢œè‰²æ˜¯çº¢è‰² ,åˆ™å°†è¯¥çˆ¶å”éƒ½æ”¹ä¸ºé»‘è‰²,å°†ç¥–çˆ¶æ”¹æˆçº¢è‰²</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">							  10,B</span></span><br><span class="line"><span class="comment">							 /     \</span></span><br><span class="line"><span class="comment">						    6,B	    15,B</span></span><br><span class="line"><span class="comment">						   /   \     /  \</span></span><br><span class="line"><span class="comment">						4,R   8,R  11,R  19,R</span></span><br><span class="line"><span class="comment">						/</span></span><br><span class="line"><span class="comment">					pnode,R</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">					==&gt;çˆ¶å”èŠ‚ç‚¹éƒ½å˜æˆé»‘è‰²ï¼Œç¥–çˆ¶å˜æˆçº¢è‰²</span></span><br><span class="line"><span class="comment">							  10,B</span></span><br><span class="line"><span class="comment">							 /     \</span></span><br><span class="line"><span class="comment">						    6,R	    15,B</span></span><br><span class="line"><span class="comment">						   /   \     /  \</span></span><br><span class="line"><span class="comment">						4,B   8,B  11,R  19,R</span></span><br><span class="line"><span class="comment">			             /</span></span><br><span class="line"><span class="comment">					  pnode,R</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">					==&gt;é€’å½’ï¼Œä»ç¥–çˆ¶ï¼ˆ6ï¼‰å¼€å§‹ï¼Œå› ä¸ºæ­¤æ—¶çˆ¶èŠ‚ç‚¹å±äºæ ¹èŠ‚ç‚¹ï¼Œæ˜¯é»‘è‰²ï¼Œæ‰€ä»¥å®Œæˆ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">					           10,B</span></span><br><span class="line"><span class="comment">							 /     \</span></span><br><span class="line"><span class="comment">						    6,R	    15,B</span></span><br><span class="line"><span class="comment">						   /   \     /  \</span></span><br><span class="line"><span class="comment">						4,B   8,B  11,R  19,R</span></span><br><span class="line"><span class="comment">			             /</span></span><br><span class="line"><span class="comment">					  pnode,R</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">if</span> pnode.getUncle() != <span class="literal">nil</span> &amp;&amp; pnode.getUncle().color == RED &#123;</span><br><span class="line">			pnode.parent.color = BLACK</span><br><span class="line">			pnode.getUncle().color = BLACK</span><br><span class="line">			pnode.getGrandParent().color = RED</span><br><span class="line">			brtree.insertCheck(pnode.getGrandParent()) <span class="comment">//å¯¹è¯¥æ ‘ä¸Šçš„èŠ‚ç‚¹é€’å½’ä¸Šå»å¤„ç†</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//2.2 çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œå”å”èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–è€…æ˜¯é»‘è‰²</span></span><br><span class="line"></span><br><span class="line">			isLeft := pnode == pnode.parent.left</span><br><span class="line">			isParentLeft := pnode.parent == pnode.getGrandParent().left</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> isLeft &amp;&amp; isParentLeft &#123;</span><br><span class="line">				<span class="comment">//2.2.1 æ˜¯å·¦å­æ ‘ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¹Ÿæ˜¯å·¦å­æ ‘</span></span><br><span class="line">				<span class="comment">/*       ...</span></span><br><span class="line"><span class="comment">						  /</span></span><br><span class="line"><span class="comment">				        8,B</span></span><br><span class="line"><span class="comment">					    /  \</span></span><br><span class="line"><span class="comment">					   7,R   /nil</span></span><br><span class="line"><span class="comment">					  /</span></span><br><span class="line"><span class="comment">					pnode,R</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				<span class="comment">//=ã€‹</span></span><br><span class="line">				<span class="comment">/*         /</span></span><br><span class="line"><span class="comment">					     7,B</span></span><br><span class="line"><span class="comment">				         /   \</span></span><br><span class="line"><span class="comment">				     pnode,R  8,R</span></span><br><span class="line"><span class="comment">				               \</span></span><br><span class="line"><span class="comment">				             /nil</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				pnode.parent.color = BLACK</span><br><span class="line">				pnode.getGrandParent().color = RED</span><br><span class="line">				brtree.rotateRight(pnode.getGrandParent())</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> !isLeft &amp;&amp; !isParentLeft &#123;</span><br><span class="line">				<span class="comment">//2.2.2 ä¸æ˜¯å·¦å­æ ‘ï¼Œçˆ¶äº²ä¹Ÿä¸æ˜¯å·¦å­æ ‘</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">						  7,B</span></span><br><span class="line"><span class="comment">					      /  \</span></span><br><span class="line"><span class="comment">					2,B/nil   8,R</span></span><br><span class="line"><span class="comment">					           \</span></span><br><span class="line"><span class="comment">					           10,pnode</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				pnode.parent.color = BLACK</span><br><span class="line">				pnode.getGrandParent().color = RED</span><br><span class="line">				brtree.rotateLeft(pnode.getGrandParent())</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> isLeft &amp;&amp; !isParentLeft &#123;</span><br><span class="line">				<span class="comment">//2.2.3 æ˜¯å·¦å­æ ‘ï¼Œä½†çˆ¶äº²ä¸æ˜¯å·¦å­æ ‘</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">						8,B</span></span><br><span class="line"><span class="comment">					    /  \</span></span><br><span class="line"><span class="comment">					6,B/nil   10,R</span></span><br><span class="line"><span class="comment">					        /</span></span><br><span class="line"><span class="comment">					      pnodeï¼ŒR</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">						pnode,R</span></span><br><span class="line"><span class="comment">					    /  \</span></span><br><span class="line"><span class="comment">					6,B/nil  8,B</span></span><br><span class="line"><span class="comment">					            \</span></span><br><span class="line"><span class="comment">					            10,R</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				brtree.rotateRight(pnode.parent)</span><br><span class="line">				<span class="comment">//å®é™…ä¸Šå˜æˆäº†2.2.2</span></span><br><span class="line">				brtree.rotateLeft(pnode.parent) <span class="comment">//pnodeç°åœ¨åœ¨åŸå…ˆpnodeçš„çˆ¶èŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">				pnode.color = BLACK</span><br><span class="line">				pnode.left.color = RED</span><br><span class="line">				pnode.right.color = RED</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> !isLeft &amp;&amp; isParentLeft &#123;</span><br><span class="line">				<span class="comment">//2.2.4ä¸æ˜¯å·¦å­æ ‘ï¼Œä½†çˆ¶äº²æ˜¯å·¦å­æ ‘</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">							 \</span></span><br><span class="line"><span class="comment">					        8,B</span></span><br><span class="line"><span class="comment">						    /  \</span></span><br><span class="line"><span class="comment">						   7,R   10,B/nil</span></span><br><span class="line"><span class="comment">						      \</span></span><br><span class="line"><span class="comment">						      pnodeï¼ŒR</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				<span class="comment">//==&gt;</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">						 8ï¼ŒB</span></span><br><span class="line"><span class="comment">					    /    \</span></span><br><span class="line"><span class="comment">					  pnode,R  10,B/nil</span></span><br><span class="line"><span class="comment">					  /</span></span><br><span class="line"><span class="comment">					7,R</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">						 pnodeï¼ŒR</span></span><br><span class="line"><span class="comment">					    /    \</span></span><br><span class="line"><span class="comment">					   8,B   10,B/nil</span></span><br><span class="line"><span class="comment">					  /</span></span><br><span class="line"><span class="comment">					7,R</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line"></span><br><span class="line">				brtree.rotateLeft(pnode.parent)</span><br><span class="line">				<span class="comment">//å®é™…ä¸Šå˜æˆäº†2.2.1</span></span><br><span class="line">				brtree.rotateRight(pnode.parent)</span><br><span class="line">				pnode.color = BLACK</span><br><span class="line">				pnode.left.color = RED</span><br><span class="line">				pnode.right.color = RED</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆæŠŠçº¢é»‘æ ‘æ”¾åœ¨mapä¸Šå‘¢ï¼š</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><strong>---------------------------------end-----------------------------------------------</strong>
The above code may use O(2n) space, but time complexity reduce to O(n)
<strong>!!!Everything seems done!!!</strong></p>
<p>So what if we use a <strong>large file?</strong></p>
<h3>Large File</h3>
<p>Solution: Split the large file into several files, it depends on your MEM:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HashFile</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">int</span></span>&#123;<span class="comment">//pass a url</span></span><br><span class="line">    seed:=<span class="number">131</span></span><br><span class="line">    hash:=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _,v:=<span class="keyword">range</span> url&#123;</span><br><span class="line">        hash=hash*seed+v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hash &amp; <span class="number">0x7FFFFFFF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="comment">//url:=fp.ReadLine()</span></span><br><span class="line">    pos:=HashFile(url)</span><br><span class="line">    file:=pos%<span class="number">10</span><span class="comment">//we assume that it split into 10 files</span></span><br><span class="line">    bufio.newWriter(file+<span class="string">".txt"</span>)</span><br><span class="line">    Writer.Write(file+<span class="string">".txt"</span>)<span class="comment">//write it into specific file</span></span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    urls:=<span class="built_in">make</span>([]<span class="keyword">string</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++&#123;</span><br><span class="line">        urlPlusTimes:=LoopEachFile(files)<span class="comment">//calculate each files' urls</span></span><br><span class="line">        urls=<span class="built_in">append</span>(urls,urlPlusTimes...)<span class="comment">// Here comes to the question??? how to ensure sequence???</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>Addition</h3>
<h4>unsafe</h4>
<p>map in golang is <strong>not thread-safe</strong>;
So it involves with concurrency situation, you must add <strong>sync.Mutex</strong> or <strong>sync.RWMutex</strong>
About that, can refer to <img src="/Concurrency" alt="my previous blog"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/19/Go/SortedMap/" data-id="cjxmwz4tb000saeugtbdrrqbm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/GolangMux" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/08/Go/GolangMux/" class="article-date">
  <time datetime="2019-06-08T02:10:00.000Z" itemprop="datePublished">2019-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/08/Go/GolangMux/">Golang Mux</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>å¼€å§‹åšç¬”è®°...
(ä¹‹å‰é¢è¯•è¢«æ€¼äº†)</p>
<p>&lt;!--more--&gt;</p>
<h2>è·¯ç”±åŒ¹é…åŸç†(Regexp in Router)</h2>
<p>First, let's go through its *** usage ***:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router:=mux.router()</span><br><span class="line">router.HandlerFunc(<span class="string">"/api/v&#123;version&#125;/&#123;category&#125;"</span>,handler)</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//then in handler:</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(w http.ResponseWriter,r *http.request)</span></span>&#123;</span><br><span class="line">    vars:=mux.Vars(r)<span class="comment">//Get the variables!</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Let's cut it into two parts:</p>
<h3>HandlerFunc(path,handler)</h3>
<p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HandleFunc registers a new route with a matcher for the URL path.</span></span><br><span class="line"><span class="comment">// See Route.Path() and Route.HandlerFunc().</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span> <span class="title">HandleFunc</span><span class="params">(path <span class="keyword">string</span>, f <span class="keyword">func</span>(http.ResponseWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">    *http.Request)</span>) *<span class="title">Route</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> r.NewRoute().Path(path).HandlerFunc(f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>then let's see  *** Route.Path(path) *** :</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Path -----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Path adds a matcher for the URL path.</span></span><br><span class="line"><span class="comment">// It accepts a template with zero or more URL variables enclosed by &#123;&#125;. The</span></span><br><span class="line"><span class="comment">// template must start with a "/".</span></span><br><span class="line"><span class="comment">// Variables can define an optional regexp pattern to be matched:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - &#123;name&#125; matches anything until the next slash.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// - &#123;name:pattern&#125; matches the given regexp pattern.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     r := mux.NewRouter()</span></span><br><span class="line"><span class="comment">//     r.Path("/products/").Handler(ProductsHandler)</span></span><br><span class="line"><span class="comment">//     r.Path("/products/&#123;key&#125;").Handler(ProductsHandler)</span></span><br><span class="line"><span class="comment">//     r.Path("/articles/&#123;category&#125;/&#123;id:[0-9]+&#125;").</span></span><br><span class="line"><span class="comment">//       Handler(ArticleHandler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Variable names must be unique in a given route. They can be retrieved</span></span><br><span class="line"><span class="comment">// calling mux.Vars(request).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Route)</span> <span class="title">Path</span><span class="params">(tpl <span class="keyword">string</span>)</span> *<span class="title">Route</span></span> &#123;<span class="comment">//æ ¹æ®ä¼ å…¥çš„urlå¢åŠ æ­£åˆ™åŒ¹é…</span></span><br><span class="line">	r.err = r.addRegexpMatcher(tpl, regexpTypePath)</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In *** r.err = r.addRegexpMatcher(tpl, regexpTypePath) ***
the *** regexpTypePath=0 *** means this is for matching Path instead of Host/Port/Prefix/Query</p>
<p>Continue, Go into method *** addRegexpMatcher() ***:</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addRegexpMatcher adds a host or path matcher and builder to a route.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Route)</span> <span class="title">addRegexpMatcher</span><span class="params">(tpl <span class="keyword">string</span>, typ regexpType)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> r.err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> typ == regexpTypePath || typ == regexpTypePrefix &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(tpl) &gt; <span class="number">0</span> &amp;&amp; tpl[<span class="number">0</span>] != <span class="string">'/'</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"mux: path must start with a slash, got %q"</span>, tpl)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> r.regexp.path != <span class="literal">nil</span> &#123;</span><br><span class="line">			tpl = strings.TrimRight(r.regexp.path.template, <span class="string">"/"</span>) + tpl</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	rr, err := newRouteRegexp(tpl, typ, routeRegexpOptions&#123;<span class="comment">// æ ¸å¿ƒéƒ¨åˆ†</span></span><br><span class="line">		strictSlash:    r.strictSlash,</span><br><span class="line">		useEncodedPath: r.useEncodedPath,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, q := <span class="keyword">range</span> r.regexp.queries &#123;</span><br><span class="line">		<span class="keyword">if</span> err = uniqueVars(rr.varsN, q.varsN); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> typ == regexpTypeHost &#123;</span><br><span class="line">		<span class="keyword">if</span> r.regexp.path != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err = uniqueVars(rr.varsN, r.regexp.path.varsN); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		r.regexp.host = rr</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r.regexp.host != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err = uniqueVars(rr.varsN, r.regexp.host.varsN); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> typ == regexpTypeQuery &#123;</span><br><span class="line">			r.regexp.queries = <span class="built_in">append</span>(r.regexp.queries, rr)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			r.regexp.path = rr</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	r.addMatcher(rr)<span class="comment">//è¿™é‡Œä¼šæŠŠå½“å‰matcheråŠ å…¥matcher slice</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We will find that we only enter the first *** if *** block (from line 4 - line 11):
Getinto the *** newRouteRegexp() ***</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// newRouteRegexp parses a route template and returns a routeRegexp,</span></span><br><span class="line"><span class="comment">// used to match a host, a path or a query string.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// It will extract named variables, assemble a regexp to be matched, create</span></span><br><span class="line"><span class="comment">// a "reverse" template to build URLs and compile regexps to validate variable</span></span><br><span class="line"><span class="comment">// values used in URL building.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Previously we accepted only Python-like identifiers for variable</span></span><br><span class="line"><span class="comment">// names ([a-zA-Z_][a-zA-Z0-9_]*), but currently the only restriction is that</span></span><br><span class="line"><span class="comment">// name and pattern can't be empty, and names can't contain a colon.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRouteRegexp</span><span class="params">(tpl <span class="keyword">string</span>, typ regexpType, options routeRegexpOptions)</span> <span class="params">(*routeRegexp, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">return</span> ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>I will roughly split the above code into serveral parts as below:</p>
<h4>Procedure :</h4>
<ol>
<li>æ ¹æ®æ‹¬å·ç­›é€‰å˜é‡ (braceIndices)
It will check the all *** {variable} *** in Path and save them into a slice:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// braceIndices returns the first level curly brace indices from a string.</span></span><br><span class="line"><span class="comment">// It returns an error in case of unbalanced braces.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">braceIndices</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> level, idx <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">var</span> idxs []<span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">		<span class="keyword">switch</span> s[i] &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'&#123;'</span>:</span><br><span class="line">			<span class="keyword">if</span> level++; level == <span class="number">1</span> &#123;</span><br><span class="line">				idx = i</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'&#125;'</span>:</span><br><span class="line">			<span class="keyword">if</span> level--; level == <span class="number">0</span> &#123;</span><br><span class="line">				idxs = <span class="built_in">append</span>(idxs, idx, i+<span class="number">1</span>)<span class="comment">//æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯å­˜äº†variableå¼€å§‹å’Œç»“å°¾çš„indexï¼Œè€Œä¸æ˜¯string</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> level &lt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"mux: unbalanced braces in %q"</span>, s)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> level != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"mux: unbalanced braces in %q"</span>, s)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> idxs, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>====&gt;</p>
<ol start="2">
<li>ç§»é™¤æ–œæ  (Remove endSlash)
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> has Suffix():</span><br><span class="line">    tpl = tpl[:<span class="built_in">len</span>(tpl)<span class="number">-1</span>]<span class="comment">//remove end slash</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>====&gt;</p>
<ol start="3">
<li>traverse idxs(variables)
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">varsN := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(idxs)/<span class="number">2</span>)<span class="comment">//å¤šå°‘ä¸ªå˜é‡</span></span><br><span class="line">varsR := <span class="built_in">make</span>([]*regexp.Regexp, <span class="built_in">len</span>(idxs)/<span class="number">2</span>)<span class="comment">//å¤šå°‘ä¸ªå˜é‡çš„åŒ¹é…</span></span><br><span class="line">pattern := bytes.NewBufferString(<span class="string">""</span>)</span><br><span class="line">pattern.WriteByte(<span class="string">'^'</span>)</span><br><span class="line">reverse := bytes.NewBufferString(<span class="string">""</span>)</span><br><span class="line"><span class="keyword">var</span> end <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(idxs); i += <span class="number">2</span> &#123;<span class="comment">//å› ä¸ºä¹‹å‰è¯´è¿‡idxsé‡Œé¢æ˜¯index,+=2å®é™…æ˜¯éå†ä¸‹ä¸€ä¸ªå˜é‡</span></span><br><span class="line">    <span class="comment">// Set all values we are interested in.</span></span><br><span class="line">    raw := tpl[end:idxs[i]]<span class="comment">//æ‹¬å·ä¹‹å‰çš„string</span></span><br><span class="line">    end = idxs[i+<span class="number">1</span>]<span class="comment">//æŒ‡çš„æ˜¯closed bracket</span></span><br><span class="line">    parts := strings.SplitN(tpl[idxs[i]+<span class="number">1</span>:end<span class="number">-1</span>], <span class="string">":"</span>, <span class="number">2</span>)<span class="comment">//æŠŠå˜é‡ç»™å¼„å‡ºæ¥,ä¸è¿‡å¯èƒ½æœ‰&#123;name:pattern&#125;è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥è¦åˆ†å‰²å¼€</span></span><br><span class="line">    name := parts[<span class="number">0</span>]</span><br><span class="line">    patt := defaultPattern <span class="comment">//defaultPatternæ˜¯ [^/]+,å³åŒ¹é…â€˜/â€™å¤šæ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span> &#123;</span><br><span class="line">        patt = parts[<span class="number">1</span>]<span class="comment">//å¦‚æœæœ‰æ£€æµ‹åˆ°ï¼šï¼Œå°±ç”¨åé¢çš„æ­£åˆ™</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Name or pattern can't be empty.</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">""</span> || patt == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"mux: missing name or pattern in %q"</span>,</span><br><span class="line">            tpl[idxs[i]:end])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Build the regexp pattern.</span></span><br><span class="line">    fmt.Fprintf(pattern, <span class="string">"%s(?P&lt;%s&gt;%s)"</span>, regexp.QuoteMeta(raw), varGroupName(i/<span class="number">2</span>), patt)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the reverse template.</span></span><br><span class="line">    fmt.Fprintf(reverse, <span class="string">"%s%%s"</span>, raw)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append variable name and compiled pattern.</span></span><br><span class="line">    varsN[i/<span class="number">2</span>] = name<span class="comment">//ï¼ï¼ï¼ï¼è¿™ä¸ªå°±æ˜¯å˜é‡çš„å­˜å‚¨ä½ç½®</span></span><br><span class="line">    varsR[i/<span class="number">2</span>], err = regexp.Compile(fmt.Sprintf(<span class="string">"^%s$"</span>, patt))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>è¿”å›åå›åˆ° *<em>func (r <em>Route) addRegexpMatcher(tpl string, typ regexpType) error</em></em> funcï¼Œ
è¿™ä¸ªå‡½æ•°æœ€åä¼šæŠŠmatchåŠ å…¥matchersé‡Œé¢
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addMatcher adds a matcher to the route.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Route)</span> <span class="title">addMatcher</span><span class="params">(m matcher)</span> *<span class="title">Route</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.err == <span class="literal">nil</span> &#123;</span><br><span class="line">		r.matchers = <span class="built_in">append</span>(r.matchers, m)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li></li>
</ol>
<h3>Vars()</h3>
<p>The place used by mux to save variables called *** context *** (ä¸Šä¸‹æ–‡)
And we have to talk about the *** context in 'net/http' ***:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸ªæ˜¯muxé‡Œé¢çš„context</span></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Context </span></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RouteMatch stores information about a matched route.</span></span><br><span class="line"><span class="keyword">type</span> RouteMatch <span class="keyword">struct</span> &#123;</span><br><span class="line">	Route   *Route</span><br><span class="line">	Handler http.Handler</span><br><span class="line">	Vars    <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// MatchErr is set to appropriate matching error</span></span><br><span class="line">	<span class="comment">// It is set to ErrMethodMismatch if there is a mismatch in</span></span><br><span class="line">	<span class="comment">// the request method and route method</span></span><br><span class="line">	MatchErr error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> contextKey <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	varsKey contextKey = <span class="literal">iota</span></span><br><span class="line">	routeKey</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vars returns the route variables for the current request, if any.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Vars</span><span class="params">(r *http.Request)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> rv := contextGet(r, varsKey); rv != <span class="literal">nil</span> &#123;<span class="comment">//è¿™é‡Œä¼šä»requestçš„contexté‡Œé¢è·å–key-value pairï¼Œç„¶åè½¬æ¢æˆmap</span></span><br><span class="line">		<span class="keyword">return</span> rv.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Then go into *** contextGet(r,varsKey) ***:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//"mux"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contextGet</span><span class="params">(r *http.Request, key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> r.Context().Value(key)<span class="comment">//å‘ç°ç”¨çš„æ˜¯net/httpé‡Œé¢çš„context</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Context struct in *** &quot;net/http&quot; ***å¯ä»¥å‚è€ƒè‡ªå·±å†™çš„ä¸€ä¸ª<a href="/Context.html">context</a></p>
<p>ä¸€åˆ‡åˆ°æœ€åï¼ŒhandleFunc()ä¼šè°ƒç”¨ServeHTTPï¼ˆw,reqï¼‰ï¼Œé‡Œé¢å°±ä¼šæŠŠRouteMatchçš„varså¯¼å‡ºï¼Œæ”¾å…¥httpåŒ…é‡Œçš„contexté‡Œ
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeHTTP dispatches the handler registered in the matched route.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// When there is a match, the route variables can be retrieved calling</span></span><br><span class="line"><span class="comment">// mux.Vars(request).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Router)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !r.skipClean &#123;</span><br><span class="line">		path := req.URL.Path</span><br><span class="line">		<span class="keyword">if</span> r.useEncodedPath &#123;</span><br><span class="line">			path = req.URL.EscapedPath()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Clean path to canonical form and redirect.</span></span><br><span class="line">		<span class="keyword">if</span> p := cleanPath(path); p != path &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Added 3 lines (Philip Schlump) - It was dropping the query string and #whatever from query.</span></span><br><span class="line">			<span class="comment">// This matches with fix in go 1.2 r.c. 4 for same problem.  Go Issue:</span></span><br><span class="line">			<span class="comment">// http://code.google.com/p/go/issues/detail?id=5252</span></span><br><span class="line">			url := *req.URL</span><br><span class="line">			url.Path = p</span><br><span class="line">			p = url.String()</span><br><span class="line"></span><br><span class="line">			w.Header().Set(<span class="string">"Location"</span>, p)</span><br><span class="line">			w.WriteHeader(http.StatusMovedPermanently)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> match RouteMatch</span><br><span class="line">	<span class="keyword">var</span> handler http.Handler</span><br><span class="line">	<span class="keyword">if</span> r.Match(req, &amp;match) &#123;</span><br><span class="line">		handler = match.Handler</span><br><span class="line">		req = setVars(req, match.Vars)<span class="comment">//è¿™é‡Œï¼Œè®¾ç½®vars</span></span><br><span class="line">		req = setCurrentRoute(req, match.Route)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> handler == <span class="literal">nil</span> &amp;&amp; match.MatchErr == ErrMethodMismatch &#123;</span><br><span class="line">		handler = methodNotAllowedHandler()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> handler == <span class="literal">nil</span> &#123;</span><br><span class="line">		handler = http.NotFoundHandler()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	handler.ServeHTTP(w, req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/08/Go/GolangMux/" data-id="cjxmwz4sx000gaeugjpcf76dz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java/Java-Class" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/java/Java-Class/" class="article-date">
  <time datetime="2019-06-05T15:48:00.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/java/Java-Class/">class loading</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ç±»çš„åŠ è½½</p>
<p>åŒäº²å§”æ‰˜æ¨¡å‹</p>
<p>//todo</p>
<p>finalï¼Œstatic ç­‰åœ¨jvm å†…å­˜ä¸­çš„å¤„ç†</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/05/java/Java-Class/" data-id="cjxmwz4t0000iaeugjg28tci9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/Slice" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/Go/Slice/" class="article-date">
  <time datetime="2019-06-05T15:48:00.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/Go/Slice/">Something about Slice in Go</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Golang's Slice is kinda diffrent===&gt;</p>
<p>&lt;!--more--&gt;
<img src="/img/golangusergroups.png" alt="group"></p>
<p>This article [Slice]https://blog.golang.org/slices may give you more information</p>
<h2>slice struct</h2>
<p>sliceå…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶ä¸æ˜¯ç®€å•çš„æ•°ç»„æˆ–è€…é“¾è¡¨(ä¸æƒ³ç”¨è‹±æ–‡å†™äº†)</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//actually its not visible to programmer</span></span><br><span class="line"><span class="comment">//æˆ‘è‡ªå·±è‡†æƒ³å‡ºæ¥çš„,ä½†å¯ä»¥ä»src/runtime/slice.goæ‰¾å‡º,æˆ–è€…èµ°è¿™ä¸ªé“¾æ¥ï¼šhttps://golang.org/src/runtime/slice.go</span></span><br><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span>&#123;</span><br><span class="line">    length <span class="keyword">int</span> <span class="comment">//length</span></span><br><span class="line">    pointer <span class="keyword">interface</span>&#123;&#125; <span class="comment">//point to first element, the type depends on the element</span></span><br><span class="line">    Capacity <span class="keyword">int</span><span class="comment">//maxå®¹é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šæ˜¯è¿™æ ·çš„:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span>&#123;</span><br><span class="line">    array unsafe.Pointer</span><br><span class="line">    <span class="built_in">len</span> <span class="keyword">int</span></span><br><span class="line">    <span class="built_in">cap</span> <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¥åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³åˆ°ï¼Œå¥½åƒä¸€ä¸ªå¯¹è±¡è€¶ï¼Œé‚£ä¹ˆè¿™ç©æ„å„¿ä¼ å…¥funcé‡Œé¢æ˜¯ä¸æ˜¯ä¼ æŒ‡é’ˆè¿›å»å‘¢ï¼Ÿï¼ˆå³é‡Œé¢çš„ä¿®æ”¹ä¼šå½±å“åˆ°origianlï¼Ÿï¼‰
ç­”æ¡ˆæ˜¯ä¸ä¼š</p>
<p>Example:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SubtractOneFromLength</span><span class="params">(slice []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">    slice = slice[<span class="number">0</span> : <span class="built_in">len</span>(slice)<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> slice</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Before: len(slice) ="</span>, <span class="built_in">len</span>(slice))</span><br><span class="line">    newSlice := SubtractOneFromLength(slice)<span class="comment">//you haven't passed the slice's header into it</span></span><br><span class="line">    fmt.Println(<span class="string">"After:  len(slice) ="</span>, <span class="built_in">len</span>(slice))</span><br><span class="line">    fmt.Println(<span class="string">"After:  len(newSlice) ="</span>, <span class="built_in">len</span>(newSlice))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>You *** Must *** do so:
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newSlice := SubtractOneFromLength(&amp;slice)<span class="comment">//Like this will work!</span></span><br></pre></td></tr></table></figure></p>
<h2>Enlarge Capcity</h2>
<p>ä½ å¯ä»¥ç†è§£sliceæ˜¯åŠ¨æ€åˆ—è¡¨ï¼Œåˆ°è¾¾æŸä¸ªå€¼åå¾ˆè‡ªç„¶å°±ä¼šæ‰©å®¹ï¼Œæ‰©å®¹çš„å¤§å°æ–‡æ¡£é‡Œé¢ä¹Ÿå†™äº†ï¼Œæ˜¯ç›´æ¥ *** Ã—2 ***
ä½†æ˜¯ï¼Œé‚£äº›åªé’ˆå¯¹äºæ²¡æœ‰å®šä¹‰ *** cap *** å­—æ®µçš„sliceï¼Œä¸‡ä¸€è§„å®šäº†ï¼Œåƒ
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">15</span>)</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé™å°±æ˜¯15äº†ï¼Œå¦‚æœå¼ºè¡Œappendã€‚ã€‚ã€‚ã€‚ã€‚ã€‚*** ä¹Ÿæ²¡å…³ç³»! ***ï¼Œåªæ˜¯è¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œæ‰©å®¹ï¼Œç„¶å,åŸsliceçš„åœ°å€ï¼ˆå³ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼‰ä¼šè¿›è¡Œæ”¹å˜
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">slice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">slice[<span class="number">0</span>]=<span class="number">1</span></span><br><span class="line">slice=<span class="built_in">append</span>(slice,<span class="number">3</span>)</span><br><span class="line">fmt.Println(&amp;slice[<span class="number">0</span>])<span class="comment">//0x414020</span></span><br><span class="line"></span><br><span class="line">slice=<span class="built_in">append</span>(slice,<span class="number">4</span>)</span><br><span class="line">fmt.Println(&amp;slice[<span class="number">0</span>])<span class="comment">//0x414040</span></span><br></pre></td></tr></table></figure></p>
<p>åŒæ ·ï¼Œ*** è¿™é‡Œæœ‰å¦å¤–å‡ ä¸ªå‘ ***ï¼š</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//example in docs</span></span><br><span class="line">    slice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"len: %d, cap: %d\n"</span>, <span class="built_in">len</span>(slice), <span class="built_in">cap</span>(slice))<span class="comment">//15</span></span><br><span class="line">    newSlice := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(slice), <span class="number">2</span>*<span class="built_in">cap</span>(slice))</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> slice &#123;</span><br><span class="line">        newSlice[i] = slice[i]</span><br><span class="line">    &#125;</span><br><span class="line">    slice = newSlice</span><br><span class="line">    fmt.Printf(<span class="string">"len: %d, cap: %d\n"</span>, <span class="built_in">len</span>(slice), <span class="built_in">cap</span>(slice))<span class="comment">//30</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>
<p>ç©¶ç«Ÿæ˜¯å“ªä¸ªslice
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">a:=<span class="built_in">make</span>([]<span class="keyword">int</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">a[<span class="number">0</span>]=<span class="number">1</span></span><br><span class="line">a[<span class="number">1</span>]=<span class="number">2</span></span><br><span class="line">a[<span class="number">2</span>]=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">b:=<span class="built_in">append</span>(a,<span class="number">4</span>)</span><br><span class="line">c:=<span class="built_in">append</span>(a,<span class="number">100</span>)</span><br><span class="line">fmt.Println(&amp;a[<span class="number">0</span>], &amp;b[<span class="number">0</span>], &amp;c[<span class="number">0</span>]) <span class="comment">//0xc0000125c0 0xc0000125c0 0xc0000125c0   Found that they use the same memory address</span></span><br><span class="line">fmt.Println(a, b, c)<span class="comment">//[1 2 3] [1 2 3 100] [1 2 3 100]</span></span><br><span class="line"></span><br><span class="line">c[<span class="number">0</span>] = <span class="number">101</span></span><br><span class="line">fmt.Println(a, b, c)<span class="comment">//[101 2 3] [101 2 3 100] [101 2 3 100]</span></span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>å€¼ä¼ é€’ï¼Ÿå¼•ç”¨ä¼ é€’ï¼Ÿ</p>
</li>
</ol>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">y:=[]<span class="keyword">int</span>&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;</span><br><span class="line">add(y)<span class="comment">//ä½ å¯èƒ½è¿™æ ·å­æ¨è®ºï¼šgoé‡Œé¢éƒ½æ˜¯å€¼ä¼ é€’==&gt;æ‰€ä»¥è¿™é‡Œé¢çš„æ”¹åŠ¨ä¸ä¼šå½±å“åˆ°yã€‚å¯æƒœï¼Œè¿™æ˜¯é”™çš„</span></span><br><span class="line">fmt.Println(y)<span class="comment">//&#123;1,1,1&#125;  ///wtfï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(y []<span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    <span class="comment">// for _,v:=range y&#123; //è¿™ä¸ªå°±ä¸ä¼šæ”¹å˜ï¼Œå› ä¸ºè¿™ä¸ªvåªæ˜¯å€¼çš„æ‹·è´</span></span><br><span class="line">    <span class="comment">//     v++</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">for</span> i:=<span class="keyword">range</span> y&#123;</span><br><span class="line">        y[i]++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5>æ³¨æ„ï¼š</h5>
<p>å…¶å®ä¸Šé¢å·²ç»æåˆ°ï¼Œsliceæ˜¯ä¸€ä¸ªstructï¼Œä¼ å…¥çš„æ—¶å€™å¦‚æœä»…ä»…æ˜¯ä¿®æ”¹ä¸€ä¸‹å…ƒç´ çš„å†…å®¹ï¼Œæ˜¯ä¸ä¼šå¯¹å…¶å¤´éƒ¨åœ°å€è¿›è¡Œæ”¹å˜ï¼Œæ‰€ä»¥ï¼Œä¼ å…¥ä¿®æ”¹å…¶å€¼æ˜¯å¯ä»¥çš„;</p>
<p>ä½†æ˜¯ï¼Œåšä¸€äº›æ¯”å¦‚appendä¹‹ç±»çš„æ“ä½œï¼Œè¿™æ ·ä¼šä½¿æ•´ä¸ªsliceå‘ç”Ÿå˜åŒ–ï¼Œ<strong>å…¶å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ–°çš„slice</strong>ï¼Œæ‰€ä»¥åŸæ¥çš„sliceå°±ä¸ä¼šè¢«æ”¹å˜</p>
<p>è¿™é‡Œæ”¾ä¸Šæ‰©å®¹çš„æºç :</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// growslice handles slice growth during append.</span></span><br><span class="line"><span class="comment">// It is passed the slice element type, the old slice, and the desired new minimum capacity,</span></span><br><span class="line"><span class="comment">// and it returns a new slice with at least that capacity, with the old data</span></span><br><span class="line"><span class="comment">// copied into it.</span></span><br><span class="line"><span class="comment">// The new slice's length is set to the old slice's length,</span></span><br><span class="line"><span class="comment">// NOT to the new requested capacity.</span></span><br><span class="line"><span class="comment">// This is for codegen convenience. The old slice's length is used immediately</span></span><br><span class="line"><span class="comment">// to calculate where to write new values during an append.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> When the old backend is gone, reconsider this decision.</span></span><br><span class="line"><span class="comment">// The SSA backend might prefer the new length or to return only ptr/cap and save stack space.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growslice</span><span class="params">(et *_type, old slice, <span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">slice</span></span> &#123;<span class="comment">// et æŒ‡çš„æ˜¯ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Œ oldæ˜¯è€çš„sliceï¼Œcapæ˜¯ç”³è¯·çš„å®¹é‡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        callerpc := getcallerpc()</span><br><span class="line">        racereadrangepc(old.array, <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>*<span class="keyword">int</span>(et.size)), callerpc, funcPC(growslice))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> msanenabled &#123;</span><br><span class="line">        msanread(old.array, <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>*<span class="keyword">int</span>(et.size)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODOä¸æ‡‚</span></span><br><span class="line">    <span class="keyword">if</span> et.size == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">cap</span> &lt; old.<span class="built_in">cap</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(errorString(<span class="string">"growslice: cap out of range"</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// append should not create a slice with nil pointer but non-zero len.</span></span><br><span class="line">        <span class="comment">// We assume that append doesn't need to preserve old.array in this case.</span></span><br><span class="line">        <span class="keyword">return</span> slice&#123;unsafe.Pointer(&amp;zerobase), old.<span class="built_in">len</span>, <span class="built_in">cap</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-------------è®¡ç®—æ‰©å®¹æ•°é‡-----------------</span></span><br><span class="line">    newcap := old.<span class="built_in">cap</span></span><br><span class="line">    doublecap := newcap + newcap</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">cap</span> &gt; doublecap &#123;<span class="comment">//ç”³è¯·å®¹é‡ &gt; 2 * æ—§çš„å®¹é‡</span></span><br><span class="line">        newcap = <span class="built_in">cap</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> old.<span class="built_in">len</span> &lt; <span class="number">1024</span> &#123;<span class="comment">//è€å®¹é‡ &lt; 1024ï¼Œç›´æ¥æ‰©æˆæ—§çš„ä¸¤å€</span></span><br><span class="line">            newcap = doublecap</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Check 0 &lt; newcap to detect overflow</span></span><br><span class="line">            <span class="comment">// and prevent an infinite loop.</span></span><br><span class="line">            <span class="keyword">for</span> <span class="number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="built_in">cap</span> &#123;<span class="comment">//å¥½åƒçœ‹è§æœ‰æ–‡ç« èªªæ˜¯1.25å€ï¼Œä½†å®é™…å¹¶ä¸æ˜¯ï¼Œå¯ä»¥å¾€ä¸‹ç»§ç»­çœ‹capmenå˜é‡</span></span><br><span class="line">                newcap += newcap / <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Set newcap to the requested cap when</span></span><br><span class="line">            <span class="comment">// the newcap calculation overflowed.</span></span><br><span class="line">            <span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;<span class="comment">//æº¢å‡ºçš„è¯å°±ä½¿ä¹‹ç­‰äºç”³è¯·çš„å®¹é‡</span></span><br><span class="line">                newcap = <span class="built_in">cap</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-------------ä»¥ä¸Šè®¡ç®—æ‰©å®¹æ•°é‡ç»“æŸ--------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//-------------TODOä»¥ä¸‹å¼€å§‹è®¡ç®—å†…å­˜ä½ç½®ï¼Œä¸ä½†ç»§ç»­è®¡ç®—æ–°çš„å®¹é‡å¤§å°ï¼Œè¿˜è¦å†³å®šæ‰©å®¹åæ˜¯å¦è¦é‡æ–°åˆ’åˆ†å†…å­˜------------------</span></span><br><span class="line">    <span class="keyword">var</span> overflow <span class="keyword">bool</span></span><br><span class="line">    <span class="keyword">var</span> lenmem, newlenmem, capmem <span class="keyword">uintptr</span></span><br><span class="line">    <span class="comment">// Specialize for common values of et.size.</span></span><br><span class="line">    <span class="comment">// For 1 we don't need any division/multiplication.</span></span><br><span class="line">    <span class="comment">// For sys.PtrSize, compiler will optimize division/multiplication into a shift by a constant.//è¿™é‡Œå°±è¯´åˆ°ä¼šä¼˜åŒ–</span></span><br><span class="line">    <span class="comment">// For powers of 2, use a variable shift.</span></span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> et.size == <span class="number">1</span>:</span><br><span class="line">        lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>)</span><br><span class="line">        newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>)</span><br><span class="line">        capmem = roundupsize(<span class="keyword">uintptr</span>(newcap))<span class="comment">//è¿™ä¸ªä¸œè¥¿ï¼Œæ„Ÿè§‰æœ‰å…³äºå†…å­˜å¯¹é½TODO</span></span><br><span class="line">        overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc</span><br><span class="line">        newcap = <span class="keyword">int</span>(capmem)</span><br><span class="line">    <span class="keyword">case</span> et.size == sys.PtrSize:<span class="comment">//æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¤§å°</span></span><br><span class="line">        lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * sys.PtrSize</span><br><span class="line">        newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * sys.PtrSize</span><br><span class="line">        capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) * sys.PtrSize)</span><br><span class="line">        overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc/sys.PtrSize</span><br><span class="line">        newcap = <span class="keyword">int</span>(capmem / sys.PtrSize)<span class="comment">//sys.PtrSizeæŒ‡çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„sizeï¼Œ64ä½çš„æœºå™¨å°±æ˜¯8</span></span><br><span class="line">    <span class="keyword">case</span> isPowerOfTwo(et.size):<span class="comment">//2æ¬¡å¹‚ä¼šç”¨variable shift</span></span><br><span class="line">        <span class="keyword">var</span> shift <span class="keyword">uintptr</span></span><br><span class="line">        <span class="keyword">if</span> sys.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line">            <span class="comment">// Mask shift for better code generation.</span></span><br><span class="line">            shift = <span class="keyword">uintptr</span>(sys.Ctz64(<span class="keyword">uint64</span>(et.size))) &amp; <span class="number">63</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            shift = <span class="keyword">uintptr</span>(sys.Ctz32(<span class="keyword">uint32</span>(et.size))) &amp; <span class="number">31</span></span><br><span class="line">        &#125;</span><br><span class="line">        lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) &lt;&lt; shift</span><br><span class="line">        newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) &lt;&lt; shift</span><br><span class="line">        capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) &lt;&lt; shift)</span><br><span class="line">        overflow = <span class="keyword">uintptr</span>(newcap) &gt; (maxAlloc &gt;&gt; shift)</span><br><span class="line">        newcap = <span class="keyword">int</span>(capmem &gt;&gt; shift)</span><br><span class="line">    <span class="keyword">default</span>:<span class="comment">//å…¶ä»–çš„æƒ…å†µå°±ç›´æ¥é™¤ä»¥et.size</span></span><br><span class="line">        lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * et.size</span><br><span class="line">        newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * et.size</span><br><span class="line">        capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) * et.size)</span><br><span class="line">        overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxSliceCap(et.size)</span><br><span class="line">        newcap = <span class="keyword">int</span>(capmem / et.size)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The check of overflow (uintptr(newcap) &gt; maxSliceCap(et.size))</span></span><br><span class="line">    <span class="comment">// in addition to capmem &gt; _MaxMem is needed to prevent an overflow</span></span><br><span class="line">    <span class="comment">// which can be used to trigger a segfault on 32bit architectures</span></span><br><span class="line">    <span class="comment">// with this example program:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// type T [1&lt;&lt;27 + 1]int64</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// var d T</span></span><br><span class="line">    <span class="comment">// var s []T</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// func main() &#123;</span></span><br><span class="line">    <span class="comment">//   s = append(s, d, d, d, d)</span></span><br><span class="line">    <span class="comment">//   print(len(s), "\n")</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">cap</span> &lt; old.<span class="built_in">cap</span> || overflow || capmem &gt; maxAlloc &#123;</span><br><span class="line">        <span class="built_in">panic</span>(errorString(<span class="string">"growslice: cap out of range"</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> p unsafe.Pointer         <span class="comment">//è¿™ä¸ªåº”è¯¥æ˜¯åœ°å€äº†</span></span><br><span class="line">    <span class="keyword">if</span> et.kind&amp;kindNoPointers != <span class="number">0</span> &#123;</span><br><span class="line">        p = mallocgc(capmem, <span class="literal">nil</span>, <span class="literal">false</span>)<span class="comment">//ç”³è¯·å†…å­˜ç©ºé—´</span></span><br><span class="line">        memmove(p, old.array, lenmem)</span><br><span class="line">        <span class="comment">// The append() that calls growslice is going to overwrite from old.len to cap (which will be the new length).</span></span><br><span class="line">        <span class="comment">// Only clear the part that will not be overwritten.</span></span><br><span class="line">        memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note: can't use rawmem (which avoids zeroing of memory), because then GC can scan uninitialized memory.</span></span><br><span class="line">        p = mallocgc(capmem, et, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> !writeBarrier.enabled &#123;</span><br><span class="line">            memmove(p, old.array, lenmem)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> i := <span class="keyword">uintptr</span>(<span class="number">0</span>); i &lt; lenmem; i += et.size &#123;</span><br><span class="line">                typedmemmove(et, add(p, i), add(old.array, i))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slice&#123;p, old.<span class="built_in">len</span>, newcap&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é’ˆå¯¹ä»¥ä¸Šé—®é¢˜çš„ç­”æ¡ˆä¹Ÿæœ‰äº†ï¼š</p>
<ol>
<li>å› ä¸ºa,b,cçš„å¤´æŒ‡é’ˆåœ°å€éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥å…¶å®å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªsliceï¼Œæ‰€ä»¥åé¢å¯¹ä»»æ„ä¸€ä¸ªè¿›è¡Œæ”¹å˜ï¼Œéƒ½ä¼šè¦†ç›–å…¶ä»–çš„æ”¹å˜</li>
</ol>
<ol start="2">
<li>sliceä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ï¼Œå…¶å®å¯ä»¥æ”¹å˜å…¶ä¸­çš„å…ƒç´ ï¼Œä½†æ˜¯ä¸èƒ½æ”¹å˜è‡ªå·±ã€‚å¦‚æœéœ€è¦ï¼Œå¿…é¡»ä»è¿”å›å€¼æˆ–ä¼ æŒ‡é’ˆå…¥æ‰‹</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/05/Go/Slice/" data-id="cjxmwz4t2000jaeugbtkboj7k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java/Java-constantPool" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/java/Java-constantPool/" class="article-date">
  <time datetime="2019-06-05T15:48:00.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/java/Java-constantPool/">Java String constatn pool</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>//todo</p>
<p>å­—ç¬¦ä¸²å¸¸é‡æ± </p>
<h3>å†…å­˜ç»“æ„</h3>
<p><img src="/img/jvm_memStruct.jpg" alt="Mem" title="jvm Memstruct"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/05/java/Java-constantPool/" data-id="cjxmwz4te000vaeug7n4zbs2e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Go/Concurrency" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/Go/Concurrency/" class="article-date">
  <time datetime="2019-06-05T15:48:00.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/Go/Concurrency/">Concurrency Problem</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li>Channel</li>
</ol>
<p>1.1 äº’æ–¥</p>
<p>è¦å…ˆæ˜ç™½ä¸€å¥è¯</p>
<blockquote>
<blockquote>
<p>Share memory by communication, do not communicate by sharing memory
é€šè¿‡é€šä¿¡æ¥åˆ†äº«å†…å­˜ï¼Œè€Œä¸æ˜¯é åˆ†äº«å†…å­˜æ¥é€šä¿¡</p>
</blockquote>
</blockquote>
<p>è¿™å¥è¯åº”è¯¥è§è¿‡æ— æ•°éäº†ï¼Œä½†è¿™å°±æ˜¯golang channelçš„æ ¸å¿ƒæ€æƒ³</p>
<p>ä½œä¸ºchannelï¼Œé¡¾åæ€ä¹‰ï¼Œå°±åƒä¸€ä¸ªç®¡é“ä¸€æ ·ï¼Œä¸»è¦å°±æ˜¯æ§åˆ¶æ•°æ®æµå‘ï¼ˆDataFlowï¼‰ï¼Œä»è€Œå¯ä»¥æ§åˆ¶å¤šä¸ªåç¨‹é—´çš„åä½œï¼Œè¾¾åˆ°äº’æ–¥ï¼ŒåŒæ­¥ç­‰ç›®çš„</p>
<p>1.2 å½“æŠŠchannelå½“ä½œä¼ å…¥å‚æ•°çš„æ—¶å€™è¦å…ˆç¡®å®šä¸€ä¸‹ç®­å¤´æ–¹å‘</p>
<p>chan&lt;-stringï¼šæŒ‡çš„æ˜¯å¯ä»¥å…¥å¯ä»¥å‡ºçš„channel
&lt;-chan stringï¼šæŒ‡çš„æ˜¯receive-only channnel</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gobyexample ä¾‹å­</span></span><br><span class="line"><span class="comment">// This `ping` function only accepts a channel for sending</span></span><br><span class="line"><span class="comment">// values. It would be a compile-time error to try to</span></span><br><span class="line"><span class="comment">// receive on this channel.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ping</span><span class="params">(pings <span class="keyword">chan</span>&lt;- <span class="keyword">string</span>, msg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    pings &lt;- msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The `pong` function accepts one channel for receives</span></span><br><span class="line"><span class="comment">// (`pings`) and a second for sends (`pongs`).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pong</span><span class="params">(pings &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>, pongs <span class="keyword">chan</span>&lt;- <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    msg := &lt;-pings</span><br><span class="line">    pongs &lt;- msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    pings := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line">    pongs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">1</span>)</span><br><span class="line">    ping(pings, <span class="string">"passed message"</span>)</span><br><span class="line">    pong(pings, pongs)</span><br><span class="line">    fmt.Println(&lt;-pongs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>Mutexäº’æ–¥é‡</li>
</ol>
<p>2.1 01äº’æ–¥é‡</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sema=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;,<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¯æ¬¡ä½¿ç”¨å‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Deposit</span><span class="params">(amount <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    sema&lt;-<span class="keyword">struct</span>&#123;&#125;&#123;&#125;<span class="comment">//é”ä½ï¼Œå¾€é‡Œé¢åŠ ä¸€ä¸ª</span></span><br><span class="line">    balance+=amount</span><br><span class="line">    &lt;-sema<span class="comment">//é‡Šæ”¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.2 Sync.Mutex äº’æ–¥é‡</p>
<p>æ³¨æ„ï¼š golangçš„é”éƒ½ä¸æ˜¯å¯é‡å…¥é”(ReentranLock),å‚è€ƒä¸€ä¸‹Javaçš„ <img src="../Java-Concurrency.html" alt="å¯é‡å…¥é”"></p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mu Sync.Mutex</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Deposit</span><span class="params">(amount <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	mu.Lock()</span><br><span class="line">	balance = balance + amount</span><br><span class="line">	mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// func Withdraw() int &#123;</span></span><br><span class="line"><span class="comment">// 	return &lt;-balances</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Balance</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> mu.Unlock</span><br><span class="line">	b := balance</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Withdraw</span><span class="params">(amount <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> mu.Unlock()</span><br><span class="line">	Deposit(-amount)<span class="comment">//è¿™é‡Œï¼Œé‡ç”¨äº†muçš„é”ï¼Œä½†æ˜¯ï¼Œgolangä¸æ”¯æŒé‡å…¥é”ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¿›è¡Œé˜»å¡</span></span><br><span class="line">	<span class="keyword">if</span> Balance() &lt; <span class="number">0</span> &#123;</span><br><span class="line">		Deposit(amount)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.2.* RWMutex è¯»å†™äº’æ–¥é‡</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mu Sync.RWMutex</span><br></pre></td></tr></table></figure></p>
<p>*** å†™æ“ä½œ Lock(), UnLock() ***
*** è¯»æ“ä½œ RLock(), RUnlock() ***</p>
<p>è¯»é”å³æ˜¯ åŒä¸€æ—¶é—´å…è®¸å¤šä¸ªè¯»çš„åç¨‹ï¼Œä½†åªå…è®¸ä¸€ä¸ªå†™çš„åç¨‹</p>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//é‡å†™Balance()</span></span><br><span class="line"><span class="keyword">var</span> mu Sync.RWMutex</span><br><span class="line"><span class="keyword">var</span> balance <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Balance</span><span class="params">()</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    mu.RLock()</span><br><span class="line">    <span class="keyword">defer</span> mu.RUnlock()</span><br><span class="line">    b:=balance</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>Sync.WaitGroup ç­‰å¾…ç»„ (Java CountDownLatch)</li>
</ol>
<p>Sync.WaitGroup
æœ‰ä¸‰ä¸ªmethods:</p>
<ol>
<li>Add(delta int):å°†ä½ è¦ç­‰å¾…çš„åç¨‹åŠ å…¥ï¼Œdeltaå³åŠ å…¥çš„æ•°é‡</li>
<li>Done() : ä»£è¡¨å½“å‰åç¨‹å®Œæˆ</li>
<li>Wait() : ç­‰å¾…æ‰€æœ‰åç¨‹å®Œæˆ(è°ƒç”¨Done())ï¼Œå®Œæˆåå³è¿”å›ï¼Œå¦åˆ™ä¸€ç›´é˜»å¡</li>
</ol>
<p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸¾ä¸ªä¾‹å­ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">(number <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> wg Sync.WaitGroup</span><br><span class="line">    wg.Add(number)<span class="comment">//è¦åŒæ­¥çš„åç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;number;i++&#123;</span><br><span class="line">        <span class="keyword">go</span> doSth(&amp;wg,i)</span><br><span class="line">    &#125;</span><br><span class="line">    begin:=Time.Now()</span><br><span class="line">    wg.Wait()<span class="comment">//å®Œæˆåç»§ç»­å¾€ä¸‹è·‘</span></span><br><span class="line">    end:=Time.Now()<span class="comment">//è¿™é‡Œè¿˜å¯ä»¥è¿™æ ·è¿›è¡Œæ‰¹é‡æµ‹è¯•</span></span><br><span class="line">    dur:=Time.Duration(end-begin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSth</span><span class="params">(wg *Sync.WaitGroup,num <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">    fmt.Println(num)</span><br><span class="line">    wg.Done()<span class="comment">//å®Œæˆå°±Done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>Sync.Once å•ä¾‹ï¼ˆä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ã€‚ã€‚ã€‚ï¼‰</li>
</ol>
<p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åªè¿è¡Œä¸€æ¬¡çš„æ„æ€ï¼Œå¾ˆæ˜¾ç„¶é€‚åˆå•ä¾‹æ¨¡å¼
éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒOnceåªæœ‰ä¸€ä¸ªMethod
Doï¼ˆfunc(){}ï¼‰: Doæ–¹æ³•åªæ¥å— *** æ— å‚æ— è¿”å›å€¼çš„å‡½æ•° ***
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> once Sync.Once</span><br><span class="line">    doOnce:=<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">        fmt.Println(<span class="string">"do ONCE!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    done:=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++&#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">            once.Do(doOnce)<span class="comment">//æœ€ç»ˆåªè¾“å‡ºä¸€è¡Œ do ONCEï¼</span></span><br><span class="line">            done&lt;-<span class="literal">true</span></span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++&#123;</span><br><span class="line">        &lt;-done</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mhh12121.github.io/2019/06/05/Go/Concurrency/" data-id="cjxmwz4t5000naeugnr0mmpa8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æ ‡ç­¾</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Pattern/">Design Pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Love/">Love</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Regular-Expression/">Regular Expression</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/networking/">networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æ ‡ç­¾äº‘</h3>
    <div class="widget tagcloud">
      <a href="/tags/Design-Pattern/" style="font-size: 10px;">Design Pattern</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/Java/" style="font-size: 16.67px;">Java</a> <a href="/tags/Javascript/" style="font-size: 13.33px;">Javascript</a> <a href="/tags/Love/" style="font-size: 10px;">Love</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Regular-Expression/" style="font-size: 10px;">Regular Expression</a> <a href="/tags/css/" style="font-size: 13.33px;">css</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/javascript/" style="font-size: 13.33px;">javascript</a> <a href="/tags/networking/" style="font-size: 10px;">networking</a> <a href="/tags/security/" style="font-size: 10px;">security</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">å½’æ¡£</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">ä¸ƒæœˆ 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">å…­æœˆ 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">å››æœˆ 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">ä¸‰æœˆ 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">ä¸€æœˆ 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">äºŒæœˆ 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">ä¸€æœˆ 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">ä¸€æœˆ 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">æœ€æ–°æ–‡ç« </h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/02/Comcon/somethingAboutTcp/">Something about Networking</a>
          </li>
        
          <li>
            <a href="/2019/06/29/Go/gRPC/">Something in gRPC</a>
          </li>
        
          <li>
            <a href="/2019/06/26/ToMyLover/">To my lover</a>
          </li>
        
          <li>
            <a href="/2019/06/21/Go/Context/">Golang Context</a>
          </li>
        
          <li>
            <a href="/2019/06/19/Go/SortedMap/">Something should be noted in golang&#39;s map</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Doujohner<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>